<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap');
    body { font-family: 'Noto Sans TC', sans-serif; background-color: #f4f7fe; color: #2d3748; padding: 16px; }
    .card { background: white; border-radius: 20px; padding: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.02); margin-bottom: 20px; border: 1px solid #e2e8f0; }
    .section-title { font-size: 14px; font-weight: 900; color: #6366f1; letter-spacing: 1px; margin-bottom: 16px; }
    input, select, textarea { font-size: 16px !important; height: 48px; width: 100%; padding: 0 16px; border: 2px solid #edf2f7; border-radius: 12px; background: #f8fafc; outline: none; }
    .table-input { height: 40px !important; background: #f1f5f9; text-align: center; border: none; border-radius: 10px; font-size: 14px !important; }
    .btn-primary { background: #4f46e5; color: white; font-weight: 700; height: 48px; border-radius: 12px; width: 100%; cursor: pointer; border: none; }
    .checkbox-pill { display: flex; align-items: center; gap: 6px; background: #f1f5f9; padding: 8px 16px; border-radius: 100px; font-size: 13px; font-weight: 700; cursor: pointer; }
    .checkbox-pill:has(input:checked) { background: #e0e7ff; color: #4338ca; }
    .input-label { font-size: 11px; font-weight: 800; color: #94a3b8; margin-bottom: 4px; display: block; }
    .tab-btn { padding: 12px; border-radius: 15px; font-weight: 900; font-size: 14px; transition: all 0.2s; border: none; }
    .tab-active { background: #4f46e5; color: white; box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3); }
    .tab-inactive { background: #e2e8f0; color: #64748b; }
    .order-card { background: white; border-radius: 18px; padding: 16px; margin-bottom: 12px; border: 1px solid #e2e8f0; }
    .drag-over { border-bottom: 2px solid #6366f1 !important; }
    .admin-order-item {
      transition: all 0.4s ease; /* è®“é¡¯ç¤º/éš±è—/è®Šè‰²éƒ½æœ‰å¹³æ»‘å‹•ç•« */
    }
    /* è®“ç®¡ç†é€²åº¦çš„ä¸‹æ‹‰é¸å–®ç¸®å°ä¸”ç¾åŒ– */
    .status-select-mini {
      font-size: 11px !important; /* å¼·åˆ¶ç¸®å°å­—é«” */
      height: 28px !important;    /* é™ä½é«˜åº¦ */
      width: 95px !important;    /* å›ºå®šå¯¬åº¦ï¼Œé¿å…æ–‡å­—è·³å‹• */
      padding: 0 4px !important;
      appearance: none;           /* å»é™¤éƒ¨åˆ†ç€è¦½å™¨é è¨­æ¨£å¼ */
      text-align: center;
    }

    /* åœ˜å‹™çµæŸçš„å®¹å™¨æ¨£å¼ */
    .group-finished {
      background-color: #f8fafc !important;
      border-color: #e2e8f0 !important;
      pointer-events: auto; /* ä¾ç„¶å…è¨±ç®¡ç†è€…æ”¹å›ä¾† */
    }
  </style>
</head>
<body onload="initApp()">

<div class="max-w-[500px] mx-auto pb-10">
  <div class="flex gap-2 mb-6">
    <button id="tab1Btn" onclick="switchTab(1)" class="tab-btn tab-active flex-1">å…¬å‘Šæ–‡æ¡ˆèˆ‡è¨­å®š âš™ï¸</button>
    <button id="tab2Btn" onclick="switchTab(2)" class="tab-btn tab-inactive flex-1">è¨‚å–®åˆ†çµ„æ ¸å° ğŸ‘‘</button>
  </div>
  
  <div id="tab1Content">
    <div class="card" id="formCard" style="border-width: 2px;">
      <div class="section-title">01 åœ˜å‹™è¨­å®š</div>
      <div class="mb-4">
        <span class="input-label">æ‡‰æ´è‰²ä¸»é¡Œ</span>
        <select id="themeSelector" onchange="updateThemeDisplay()">
          <option value="SM" data-color="#FCE0E4">SM (#FCE0E4)</option>
          <option value="GG" data-color="#FF84C3">å°‘å¥³æ™‚ä»£ (#FF84C3)</option>
          <option value="NCT" data-color="#E1E668">NCT (#E1E668)</option>
          <option value="RZ" data-color="#FF9E23">RIIZE (#FF9E23)</option>
        </select>
      </div>
      <div class="mb-4"><span class="input-label">åœ˜å‹™åç¨±</span><input type="text" id="groupName" oninput="handleNameInput()" placeholder="ä¾‹å¦‚ï¼šNCT å®˜æ–¹å‘¨é‚Š"></div>
      <div class="mb-4"><span class="input-label">æ”¶å–®æˆªæ­¢æ™‚é–“</span><input type="datetime-local" id="deadline" oninput="updateNoteText()"></div>
      <div class="mb-4"><span class="input-label">å®˜æ–¹å‡ºè²¨æ™‚é–“</span><input type="text" id="shippingTime" oninput="updateNoteText()" placeholder="é è¨­ç‚ºï¼šå¾…æ›´æ–°"></div>
      
      <div class="grid grid-cols-2 gap-3 mb-4">
        <div>
          <span class="input-label">ä¸‹å–®æ¨¡å¼</span>
          <select id="modeSelector" onchange="toggleLinkInput()">
            <option value="1" selected>æ¨¡å¼ 1 (åŒ¯æ¬¾)</option>
            <option value="2">æ¨¡å¼ 2 (é›†é‹)</option>
            <option value="3" >æ¨¡å¼ 3 (åƒ…ä¸‹å–®)</option>
            <option value="4">æ¨¡å¼ 4 (è³£è²¨ä¾¿/å¤–éƒ¨)</option>
          </select>
        </div>
        <div id="linkInputBox" style="display:none;">
          <span class="input-label">å¤–éƒ¨é€£çµ (æ¨¡å¼ 4 å°ˆç”¨)</span>
          <input type="text" id="externalLink" placeholder="https://myship...">
        </div>
      </div>
      <button class="btn-primary" onclick="generateId()">ç”Ÿæˆåœ˜å‹™ ID ğŸš€</button>
      <div id="id-display" class="text-center mt-3 font-black text-indigo-600 text-sm"></div>
    </div>

    <div class="card">
      <div class="section-title">02 åŒ¯ç‡èˆ‡æ¯”ä¾‹</div>
      <div class="grid grid-cols-2 gap-3 mb-3">
        <select id="currencySelector" onchange="onCurrencyChange()">
          <option value="KRW" data-name="éŸ“å¹£" data-symbol="â‚©" data-extra="20" data-threshold="30000">éŸ“å¹£ (KRW)</option>
          <option value="CNY" data-name="äººæ°‘å¹£" data-symbol="Â¥" data-extra="8" data-threshold="150">äººæ°‘å¹£ (CNY)</option>
          <option value="JPY" data-name="æ—¥å¹£" data-symbol="Â¥" data-extra="12.5" data-threshold="3500">æ—¥å¹£ (JPY)</option>
          <option value="USD" data-name="ç¾é‡‘" data-symbol="$" data-extra="20" data-threshold="25">ç¾é‡‘ (USD)</option>
        </select>
        <input type="number" id="extraPercent" value="20" oninput="recalculateAll()">
      </div>
      <div class="flex gap-2">
        <input type="number" id="exchangeRate" step="0.00001" oninput="recalculateAll()" placeholder="æ­£åœ¨åŒæ­¥åŒ¯ç‡...">
        <button class="bg-slate-100 px-4 rounded-xl text-xs font-bold" onclick="syncRate()">åˆ·æ–°</button>
      </div>
    </div>

    <div class="card">
      <div class="section-title">03 å•†å“æ˜ç´°</div>
      <div class="overflow-x-auto">
        <table id="itemTable" class="w-full border-collapse">
          <thead><tr>
            <th width="30"></th>
            <th class="text-[10px] text-left">åç¨±</th>
            <th width="60" class="text-[10px]">å¤–å¹£</th>
            <th width="65" class="text-[10px]">å”®åƒ¹</th>
            <th width="40"></th>
          </tr></thead>
          <tbody id="itemBody">
            <tr draggable="true" ondragstart="dragStart(event)" ondragover="dragOver(event)" ondragleave="dragLeave(event)" ondrop="drop(event)" class="drag-row border-b border-transparent">
              <td class="text-slate-300 text-center cursor-move">â˜°</td>
              <td><input type="text" class="table-input p-name w-full" oninput="updateNoteText()"></td>
              <td><input type="number" class="table-input p-foreign w-full" oninput="calcPrice(this); updateNoteText();"></td>
              <td class="hidden"><input type="number" class="p-cost"></td>
              <td><input type="number" class="table-input p-twd w-full font-black text-indigo-600" oninput="manualPriceChange(this); updateNoteText();"></td>
              <td class="hidden"><input type="number" class="p-profit"></td>
              <td class="pl-2"><button class="btn-del" onclick="removeRow(this)">âœ•</button></td>
            </tr>
          </tbody>
        </table>
      </div>
      <button class="mt-4 text-xs font-black text-indigo-500" onclick="addRow()">+ æ–°å¢å•†å“æ¬„ä½</button>
    </div>

    <div class="card">
      <div class="section-title">04 å…¬å‘Šæ–‡æ¡ˆ</div>
      <div class="flex flex-wrap gap-2 mb-4">
        <label class="checkbox-pill"><input type="checkbox" id="checkPromo" onclick="updateNoteText()"> æ»¿é¡</label>
        <label class="checkbox-pill"><input type="checkbox" id="checkRegister" onclick="updateNoteText()"> ç™»è¨˜</label>
        <label class="checkbox-pill"><input type="checkbox" id="checkFragile" onclick="updateNoteText()"> æ˜“ç¢å“</label>
      </div>
      <div id="promoBox" class="mb-4 hidden"><input type="number" id="promoInput" oninput="updateNoteText()" placeholder="æ»¿é¡é–€æª»"></div>
      <div class="relative w-full aspect-square mb-4">
        <textarea id="customNoteText" class="w-full h-full text-[15px] leading-relaxed p-4 border-2 border-indigo-100 rounded-3xl bg-slate-50 resize-none"></textarea>
      </div>
      <div class="flex flex-col gap-3">
        <button class="btn-primary bg-slate-800" onclick="copyResult('notebook')">è¤‡è£½ã€Œè¨˜äº‹æœ¬ç‰ˆã€ğŸ“–</button>
        <div class="grid grid-cols-2 gap-3">
          <button class="btn-primary bg-rose-500 text-sm" onclick="copyResult('memo')">è¤‡è£½ã€Œå‚™å¿˜éŒ„ç‰ˆã€ğŸ“</button>
          <button class="btn-primary bg-slate-200 text-slate-700 text-sm" onclick="copyResult('post')">è¤‡è£½ã€Œç™¼æ–‡ç‰ˆã€ğŸ“±</button>
        </div>
      </div>
      <button class="btn-primary mt-6 bg-green-600" onclick="saveToSheet()">åŒæ­¥è‡³è©¦ç®—è¡¨ âœ…</button>
    </div>
    <div class="card" id="formGeneratorCard">
      <div class="section-title">05 Google è¡¨å–®ç”Ÿæˆ</div>    
        <div class="mb-4">
          <span class="input-label">é¡å¤–æ³¨æ„äº‹é … (é¸å¡«)</span>
          <textarea id="extraNote" class="h-24 p-3" placeholder="è‹¥æœ‰ç‰¹æ®Šè¦å‰‡å¯å¡«å¯«æ–¼æ­¤..."></textarea>
        </div>
    
        <button class="btn-primary bg-gradient-to-r from-pink-400 to-rose-400" id="btnGenerateForm" onclick="generateGoogleForm()">å»ºç«‹ Google è¡¨å–® âœ¨</button>

        <div id="formResult" class="result-box">
          <div class="font-bold text-slate-700 mb-2">ğŸ‰ è¡¨å–®å»ºç«‹æˆåŠŸï¼</div>
            <div class="bg-slate-100 p-2 rounded-lg mb-3 flex items-center justify-center gap-2">
              <span class="text-xs text-gray-500">æ‡‰æ´è‰²ç¢¼ï¼š</span>
              <strong id="hex-display" class="text-sm font-mono">-</strong> 
              <button class="bg-black text-white text-[10px] px-2 py-1 rounded" onclick="copyHex()">è¤‡è£½</button>
            </div>
            <div class="flex flex-col gap-2">
              <a id="edit-link" target="_blank" class="text-pink-600 font-bold underline text-sm">é€²å…¥ç·¨è¼¯æ¨¡å¼ (è¨­å®šé¡è‰²)</a>
              <a id="view-link" target="_blank" class="text-gray-400 text-xs">é è¦½å¡«å–®ç•«é¢</a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div id="tab2Content" class="hidden">
    <div class="card !p-5 mb-4 bg-white border-2 border-indigo-50 shadow-sm">
      <div class="flex items-center justify-between mb-4">
        <h3 class="font-black text-slate-700 flex items-center gap-2 text-sm">
          <span class="w-2 h-5 bg-indigo-500 rounded-full"></span>
          åœ˜å‹™é€²åº¦æ§åˆ¶å°
        </h3>
        <div class="flex items-center gap-2">
          <label class="flex items-center gap-1.5 cursor-pointer">
            <input type="checkbox" id="hideFinishedGroups" checked onchange="renderGroupControl(lastGroupsData)" class="w-3.5 h-3.5 accent-slate-500">
            <span class="text-[11px] font-bold text-slate-500">éš±è—å·²çµæŸ</span>
          </label>
          <button onclick="loadAdminOrders()" class="text-[10px] bg-slate-100 px-3 py-1 rounded-full font-bold text-slate-500 hover:bg-slate-200 transition-colors ml-2">ğŸ”„ åˆ·æ–°</button>
        </div>
      </div>
      <div id="groupStatusControlContainer" class="grid grid-cols-1 sm:grid-cols-2 gap-3">
        <div class="text-center py-4 text-slate-300 text-xs italic">è¼‰å…¥é€²åº¦ä¸­...</div>
      </div>
    </div>

    <div class="card !p-4 mb-4">
      <div class="flex flex-col gap-3">
        <input type="text" id="orderSearchInput" oninput="filterOrders()" placeholder="ğŸ” æœå°‹åœ˜å‹™ã€æš±ç¨±æˆ–è¯çµ¡æ–¹å¼..." class="!h-10 text-sm">
        <div class="flex justify-between items-center">
          <label class="flex items-center gap-2 cursor-pointer">
            <input type="checkbox" id="hideCheckedVerify" checked onchange="filterOrders()" class="w-4 h-4 accent-indigo-600">
            <span class="text-xs font-bold text-slate-600">éš±è—å·²æ ¸å°è¨‚å–®</span>
          </label>
        </div>
      </div>
    </div>

    <div id="adminOrderList" class="space-y-4">
      <div class="text-center py-20 text-slate-400 font-bold italic">è¼‰å…¥è¨‚å–®è³‡æ–™ä¸­...</div>
    </div>
  </div>

<script>
  // å®šç¾©å…¨åŸŸè®Šæ•¸
  let currentSymbol = "â‚©", currentName = "éŸ“å¹£", currentGroupId = "", dragSrcEl = null, allAdminOrders = [];

  const themeMap = {
    'GG': { id: 'GG', keywords: ['å°‘æ™‚', 'å°‘å¥³æ™‚ä»£', 'SNSD', 'GIRLS', 'å¸•å°¼', 'å¤ªå¦', 'æ½¤å¨¥', 'å­æ·µ', 'ä¿åˆ©', 'ç§€è‹±', 'å¾ç„', 'çŠå¦®', 'è’‚èŠ¬å¦®', 'TAEYEON', 'YOONA', 'HYOYEON', 'YURI', 'SOOYOUNG', 'SEOHYUN', 'SUNNY', 'TIFFANY'] },
    'NCT': { id: 'NCT', keywords: ['NCT', '127', 'DREAM', 'WISH', 'WAYV', 'DJJ', 'DOJAEJUNG', 'æ³°å®¹', 'TAEYONG', 'ç…æ·', 'JOHNNY', 'æ‚ å¤ª', 'YUTA', 'é“è‹±', 'DOYOUNG', 'åœ¨ç¹', 'JAEHYUN', 'å»·ç¥', 'JUNGWOO', 'é¦¬å…‹', 'MARK', 'æ¥·ç‡¦', 'HAECHAN', 'ä»ä¿Š', 'RENJUN', 'JENO', 'å¸åŠª', 'æ¸½æ°‘', 'JAEMIN', 'è¾°æ¨‚', 'CHENLE', 'å¿—æ™Ÿ', 'JISUNG', 'TEN', 'ææ°¸æ¬½', 'éŒ•', 'KUN', 'æ˜€æ˜€', 'WINWIN', 'è‚–ä¿Š', 'XIAOJUN', 'å† äº¨', 'HENDERY', 'æšæš', 'YANGYANG', 'SION', 'æ˜¯æº«', 'RIKU', 'é™¸', 'YUSHI', 'å‹‡å¿—', 'JAEHEE', 'æ ½ç¦§', 'RYO', 'é¼', 'SAKUYA', 'å’²å“‰'] },
    'RZ': { id: 'RZ', keywords: ['RIIZE', 'å°‡å¤ªéƒ', 'æˆç‡¦', 'æ©å¥­', 'å…ƒå½¬', 'ç‚¤ç†™', 'ç‡¦æ¦®', 'SHOTARO', 'SUNGCHAN', 'EUNSEOK', 'WONBIN', 'SOHEE', 'CHANYOUNG', 'ANTON'] },
    'SM': { id: 'SM', keywords: ['SM'] }
  };

  // åˆå§‹åŒ–
  function initApp() {
    const now = new Date();
    const deadlineInput = document.getElementById('deadline');
    if(deadlineInput) {
      deadlineInput.value = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')}T22:00`;
    }
    onCurrencyChange();
    updateThemeDisplay();
    const firstRow = document.querySelector('#itemBody tr');
    if(firstRow) bindRowEvents(firstRow);
    console.log("App Initialized");
  }

  function switchTab(num) {
    document.getElementById('tab1Content').classList.toggle('hidden', num !== 1);
    document.getElementById('tab2Content').classList.toggle('hidden', num !== 2);
    document.getElementById('tab1Btn').className = `tab-btn flex-1 ${num === 1 ? 'tab-active' : 'tab-inactive'}`;
    document.getElementById('tab2Btn').className = `tab-btn flex-1 ${num === 2 ? 'tab-active' : 'tab-inactive'}`;
    if(num === 2) loadAdminOrders();
  }

  function addRow() {
    const tr = document.createElement('tr');
    tr.draggable = true;
    tr.className = "drag-row border-b border-transparent";
    tr.innerHTML = `<td class="text-slate-300 text-center cursor-move">â˜°</td>
      <td><input type="text" class="table-input p-name w-full" oninput="updateNoteText()"></td>
      <td><input type="number" class="table-input p-foreign w-full" oninput="calcPrice(this); updateNoteText();"></td>
      <td class="hidden"><input type="number" class="p-cost"></td>
      <td><input type="number" class="table-input p-twd w-full font-black text-indigo-600" oninput="manualPriceChange(this); updateNoteText();"></td>
      <td class="hidden"><input type="number" class="p-profit"></td>
      <td class="pl-2"><button class="btn-del" onclick="removeRow(this)">âœ•</button></td>`;
    bindRowEvents(tr);
    document.getElementById('itemBody').appendChild(tr);
  }

  function bindRowEvents(tr) {
    tr.addEventListener('dragstart', dragStart);
    tr.addEventListener('dragover', dragOver);
    tr.addEventListener('dragleave', dragLeave);
    tr.addEventListener('drop', drop);
  }

  function removeRow(btn) {
    if (document.querySelectorAll('#itemBody tr').length > 1) {
      btn.closest('tr').remove();
      updateNoteText();
    }
  }

  function dragStart(e) { dragSrcEl = e.currentTarget; e.dataTransfer.effectAllowed = 'move'; }
  function dragOver(e) { if (e.preventDefault) e.preventDefault(); e.currentTarget.classList.add('drag-over'); return false; }
  function dragLeave(e) { e.currentTarget.classList.remove('drag-over'); }
  function drop(e) {
    if (e.stopPropagation) e.stopPropagation();
    e.currentTarget.classList.remove('drag-over');
    if (dragSrcEl !== e.currentTarget) {
      const allRows = Array.from(document.getElementById('itemBody').children);
      const targetIdx = allRows.indexOf(e.currentTarget);
      const srcIdx = allRows.indexOf(dragSrcEl);
      if (srcIdx < targetIdx) e.currentTarget.after(dragSrcEl);
      else e.currentTarget.before(dragSrcEl);
      updateNoteText();
    }
    return false;
  }

  function onCurrencyChange() {
    const opt = document.getElementById('currencySelector').selectedOptions[0];
    currentSymbol = opt.getAttribute('data-symbol'); 
    currentName = opt.getAttribute('data-name');
    document.getElementById('extraPercent').value = opt.getAttribute('data-extra');
    syncRate();
  }

  function syncRate() {
    if(typeof google !== 'undefined') {
      google.script.run.withSuccessHandler(rate => { 
        document.getElementById('exchangeRate').value = rate; 
        recalculateAll(); 
      }).getExchangeRate(document.getElementById('currencySelector').value);
    }
  }

  function calcPrice(el) {
    const row = el.closest('tr');
    const fv = parseFloat(el.value) || 0; // å¤–å¹£é‡‘é¡
    const rate = parseFloat(document.getElementById('exchangeRate').value) || 0; // åŒ¯ç‡
    const ex = parseFloat(document.getElementById('extraPercent').value) || 0; // é¡å¤–åˆ©æ½¤%
    
    // å–å¾—ç•¶å‰é¸ä¸­å¹£åˆ¥çš„è¨­å®š
    const opt = document.getElementById('currencySelector').selectedOptions[0];
    const threshold = parseFloat(opt.getAttribute('data-threshold')) || 0;

    // A. è¨ˆç®—æˆæœ¬ (å«åŸºæœ¬çš„ 2.515% äº¤æ˜“æ‰‹çºŒè²»)
    const masterCost = Math.ceil(fv * rate * 1.02515);
    row.querySelector('.p-cost').value = masterCost;

    // B. è¨ˆç®—åˆæ­¥å°å¹£å”®åƒ¹ (é‡‘é¡ * åŒ¯ç‡ * (1 + è¶´æ•¸))
    let twd = fv * (rate * (1 + ex / 100));

    // C. å¥—ç”¨é€šç”¨æ‰£é™¤é‚è¼¯
    // å¦‚æœå¤–å¹£é‡‘é¡é”åˆ°é–€æª»ï¼Œé€²è¡Œå‹•æ…‹æ‰£é™¤
    if (fv >= threshold && threshold > 0) {
        // é€™è£¡çš„é‚è¼¯æ˜¯å°‡åŸæœ¬éŸ“å¹£çš„å…¬å¼è½‰æ›ç‚ºã€Œæ¯”ä¾‹ã€
        // åŸå…¬å¼: (fv / 1000) - 10 
        // éŸ“å¹£ 30,000 æ™‚æ‰£ 20 å…ƒï¼Œä¹‹å¾Œæ¯å¢åŠ  1,000 æ‰£ 1 å…ƒ
        
        // æˆ‘å€‘å°‡å…¶é€šç”¨åŒ–ï¼šè¶…éé–€æª»çš„éƒ¨åˆ†çµ¦äºˆæ¸›å…
        if (currentName === "éŸ“å¹£") {
            twd -= ((fv / 1000) - 10);
        } else if (currentName === "äººæ°‘å¹£") {
            // ä¾‹å¦‚ï¼šäººæ°‘å¹£æ¯è¶…é 10 å¡Šæ‰£ 1 å…ƒ
            twd -= ((fv / 10) - 5); 
        } else if (currentName === "æ—¥å¹£") {
            // ä¾‹å¦‚ï¼šæ—¥å¹£æ¯è¶…é 100 å¡Šæ‰£ 1 å…ƒ
            twd -= ((fv / 100) - 15);
        } else if (currentName === "ç¾é‡‘") {
            // ä¾‹å¦‚ï¼šç¾é‡‘æ¯å¢åŠ  1 å¡Šæ‰£ 1 å…ƒ
            twd -= (fv - 20);
        }
    }

    // D. ç„¡æ¢ä»¶é€²ä½è‡³ 5 çš„å€æ•¸ (ä¾‹å¦‚ 192 -> 195)
    const finalPrice = Math.ceil(twd / 5) * 5;
    
    row.querySelector('.p-twd').value = finalPrice;
    row.querySelector('.p-profit').value = finalPrice - masterCost;
}

  function manualPriceChange(el) {
    const row = el.closest('tr');
    const cost = parseFloat(row.querySelector('.p-cost').value) || 0;
    row.querySelector('.p-profit').value = (parseFloat(el.value)||0) - cost;
  }

  function recalculateAll() {
    document.querySelectorAll('#itemBody tr').forEach(row => { 
      const input = row.querySelector('.p-foreign'); 
      if(input && input.value) calcPrice(input); 
    });
    updateNoteText();
  }

  function handleNameInput() {
    const name = document.getElementById('groupName').value.toUpperCase();
    const selector = document.getElementById('themeSelector');
    for (let key in themeMap) {
      if (themeMap[key].keywords.some(k => name.includes(k.toUpperCase()))) {
        selector.value = themeMap[key].id;
        updateThemeDisplay(); 
        break;
      }
    }
    updateNoteText();
  }

  function updateNoteText() {
    const isPromo = document.getElementById('checkPromo').checked;
    const isRegister = document.getElementById('checkRegister').checked;
    const isFragile = document.getElementById('checkFragile').checked;
    const promoVal = document.getElementById('promoInput').value || "xxx";
    const groupName = document.getElementById('groupName').value || "åœ˜å‹™åç¨±";
    const deadlineVal = document.getElementById('deadline').value;
    const deadlineStr = deadlineVal ? deadlineVal.replace('T', ' ').replace(/-/g, '/') : "";
    const shippingStr = document.getElementById('shippingTime').value || "å¾…æ›´æ–°";
    const currencyCode = document.getElementById('currencySelector').value;
    
    document.getElementById('promoBox').style.display = isPromo ? "block" : "none";
    
    let items = [];
    document.querySelectorAll('#itemBody tr').forEach((row, idx) => {
      const n = row.querySelector('.p-name').value;
      const t = row.querySelector('.p-twd').value;
      const f = row.querySelector('.p-foreign').value || 0;
      if(n && t) items.push((idx+1) + ". " + n + " NT$" + t + "ï½œ" + currencyCode + f);
    });

    const label = isRegister ? "ç™»è¨˜æˆªæ­¢æ™‚é–“" : "æ”¶å–®æ™‚é–“";
    let textParts = [];
    
    // âœ… é€™è£¡æ”¹ç”¨ + "\n" æ‹¼æ¥ï¼Œå¾¹åº•é¿å…è§£æéŒ¯èª¤
    if (isPromo) textParts.push("*æ»¿" + promoVal + currentName + " â‡¨ æ»¿é¡å¡*1ï¼ˆéš¨æ©Ÿï¼‰\nä¹‹å¾Œæœƒåœ¨ç¤¾ç¾¤æŠ•ç¥¨æ’å¡æ™‚é–“ï¼æœ‰å¤šçš„ä¹Ÿæœƒéš¨æ©Ÿçµ¦è·Ÿåœ˜è€…ï½");
    if (isRegister) textParts.push("è¨˜äº‹æœ¬ç•™è¨€ç™»è¨˜\nç•™è¨€è¦–åŒè³¼è²· ä¸èƒ½æ“…è‡ªåˆªé™¤ç•™è¨€ è³¼è²·æˆåŠŸå†å¡«å–®åŒ¯æ¬¾\næ¯é …å•†å“éƒ½æœ‰é™è³¼ æœƒæŒ‰ç…§ç™»è¨˜é †åºçµ¦äºˆ\néš¨æ™‚æœ‰å¯èƒ½æœƒç¼ºè²¨ å°å¸³æˆåŠŸæœƒç›´æ¥ä¸‹å–®");
    if (isFragile) textParts.push("æ˜“ç¢å“éƒ½æœƒåŠ å¼·åŒ…è£ ä½†é‚„æ˜¯æœƒæœ‰ç ´ç¢çš„é¢¨éšª");
    if (isRegister || isFragile) textParts.push("ä»¥ä¸Šéƒ½å¯ä»¥æ¥å—å†è·Ÿåœ˜ï½");
    
    const tailMsg = isRegister ? "è¬è¬" : "åŒ¯æ¬¾å®Œæˆå¾Œè«‹åœ¨æ­¤è¨˜äº‹æœ¬ç•™ä¸‹åŒ¯æ¬¾å¸³æˆ¶æœ«äº”ç¢¼\nè¬è¬";

    const finalResult = groupName + "\n\nğŸ’°å•†å“é‡‘é¡\n" + items.join('\n') + 
                        "\n\n" + label + "ï¼š" + (deadlineStr ? 'ï½'+deadlineStr : '') + 
                        "\nå®˜æ–¹å‡ºè²¨æ™‚é–“ï¼š" + shippingStr + "\n\n" + 
                        textParts.join('\n\n') + 
                        "\n\nâœ“ä»¥ä¸Šçš†éœ€äºŒè£œ\nğ–¦¹è·Ÿåœ˜å‰è«‹å…ˆè©³é–±è¨˜äº‹æœ¬é‡è¦è²¼æ–‡è£¡çš„æ³¨æ„äº‹é …\nğ–¦¹å¡«å–®å³è¦–åŒå·²é–±è®€ä¸¦åŒæ„æ‰€æœ‰å…§å®¹\n\n" + tailMsg;

    document.getElementById('customNoteText').value = finalResult;
  }

  function updateThemeDisplay() {
  const selector = document.getElementById('themeSelector');
  if (!selector || !selector.selectedOptions[0]) return;
  
  // 1. å–å¾—é¸æ“‡çš„è‰²ç¢¼
  const color = selector.selectedOptions[0].getAttribute('data-color');
  
  // 2. æ›´æ–° 01 å€çš„å¡ç‰‡é‚Šæ¡†é¡è‰²
  const formCard = document.getElementById('formCard');
  if (formCard) formCard.style.borderColor = color;
  
  // 3. æ›´æ–° 05 å€çš„æ–‡å­—é¡¯ç¤º (åŒæ­¥æŠ“å– 01 å€çš„ä¸»é¡Œè‰²)
  const hexDisplay = document.getElementById('hex-display');
  if (hexDisplay) {
    hexDisplay.innerText = color.toUpperCase();
  }
}

// ç¢ºä¿é»æ“Šè¤‡è£½æ™‚ï¼ŒæŠ“åˆ°çš„æ˜¯ç•¶å‰é¡¯ç¤ºçš„é‚£å€‹æ–‡å­—
function copyHex() {
  const hex = document.getElementById('hex-display').innerText;
  if (!hex || hex === '-') {
    alert("è«‹å…ˆé¸æ“‡ä¸»é¡Œé¡è‰²");
    return;
  }
  navigator.clipboard.writeText(hex).then(() => {
    alert('è‰²ç¢¼ ' + hex + ' å·²è¤‡è£½ï¼\nè«‹æ‰‹å‹•è‡³ Google è¡¨å–®ã€Œè‡ªè¨‚ä¸»é¡Œã€è²¼ä¸Šé¡è‰²ã€‚');
  });
}

  function copyResult(type) {
    const content = (type === 'post') ? generatePostText() : document.getElementById('customNoteText').value;
    navigator.clipboard.writeText(content).then(() => alert("å·²è¤‡è£½æˆåŠŸï¼"));
  }

  function generatePostText() {
    const groupName = document.getElementById('groupName').value || "åœ˜å‹™åç¨±";
    const deadlineVal = document.getElementById('deadline').value;
    const deadlineStr = deadlineVal ? deadlineVal.replace('T', ' ').replace(/-/g, '/') : "";
    const currencyCode = document.getElementById('currencySelector').value;
    let items = [];
    document.querySelectorAll('#itemBody tr').forEach((row, idx) => {
      const n = row.querySelector('.p-name').value;
      const t = row.querySelector('.p-twd').value;
      const f = row.querySelector('.p-foreign').value || 0;
      if(n && t) items.push((idx+1) + ". " + n + " NT$" + t + "ï½œ" + currencyCode + f);
    });
    
    // âœ… ä½¿ç”¨æ‹¼æ¥æ–¹å¼é¿é–‹åå¼•è™Ÿ Bug
    return "#ä»£è³¼ " + groupName + "\n\nğŸ’°å•†å“é‡‘é¡\n" + items.join('\n') + 
           "\n\nâœ“ä»¥ä¸Šçš†éœ€äºŒè£œ æ”¶å–®æ™‚é–“ï¼š" + (deadlineStr ? 'ï½'+deadlineStr : '') + 
           "\n\nğ–¦¹æ¬²è·Ÿåœ˜è€…è«‹åŠ å…¥ç¤¾ç¾¤å¡«å–®åŒ¯æ¬¾\nğŸ”—ï¼šhttps://reurl.cc/EQ1rLk\n\næœ‰ä»»ä½•å•é¡Œéƒ½æ­¡è¿è©¢å• è¬è¬ï½";
  }

  function generateId() {
    const theme = document.getElementById('themeSelector').value;
    if(typeof google !== 'undefined') {
      google.script.run.withSuccessHandler(res => { 
        currentGroupId = res.newId; 
        document.getElementById('id-display').innerText = "ID: " + res.newId; 
      }).addAdminGroup(
        document.getElementById('groupName').value, 
        document.getElementById('deadline').value, 
        document.getElementById('shippingTime').value, 
        theme, 
        document.getElementById('modeSelector').value, 
        document.getElementById('externalLink').value
      );
    }
  }

  function formatDeadline(val) {
    if (!val) return "";
    return val.replace(/-/g, '/').replace('T', ' ');
  }

  function generateGoogleForm() {
    const groupName = document.getElementById('groupName').value;
    if (!groupName) return alert("è«‹å…ˆè¼¸å…¥åœ˜å‹™åç¨± (01)");
    let productList = [];
    document.querySelectorAll('#itemBody tr').forEach(row => {
      const n = row.querySelector('.p-name').value, t = row.querySelector('.p-twd').value;
      if(n && t) productList.push({ name: n, price: t });
    });
    if (productList.length === 0) return alert("è«‹è‡³å°‘æ–°å¢ä¸€å€‹å•†å“ (03)");

    const data = {
      title: groupName,
      productList: productList,
      deadline: formatDeadline(document.getElementById('deadline').value),
      shippingTime: document.getElementById('shippingTime').value || "å¾…æ›´æ–°",
      extraNote: document.getElementById('extraNote').value,
      theme: document.getElementById('themeSelector').value
    };

    const btn = document.getElementById('btnGenerateForm');
    btn.innerText = "â³ æ­£åœ¨å»ºç«‹è¡¨å–®...";
    btn.disabled = true;
    
    google.script.run.withSuccessHandler(res => {
      btn.innerText = "å»ºç«‹ Google è¡¨å–® âœ¨";
      btn.disabled = false;
      if (res.success) {
        document.getElementById('formResult').style.display = 'block';
        document.getElementById('edit-link').href = res.url;
        document.getElementById('view-link').href = res.viewUrl;
      } else { alert("å»ºç«‹å¤±æ•—ï¼š" + res.error); }
    }).createForm(data);
  }


  function toggleLinkInput() {
    document.getElementById('linkInputBox').style.display = (document.getElementById('modeSelector').value === "4") ? "block" : "none";
  }

  
  /**
   * 1. å•Ÿå‹•å™¨ï¼šåŒæ™‚è¼‰å…¥åœ˜å‹™ç‹€æ…‹èˆ‡è¨‚å–®
   */
  function loadAdminOrders() {
    const listDiv = document.getElementById('adminOrderList');
    const controlDiv = document.getElementById('groupStatusControlContainer');
    
    listDiv.innerHTML = "<div class='text-center py-20 text-slate-400 font-bold italic animate-pulse'>è³‡æ–™å‚³è¼¸ä¸­...</div>";
    
    if(typeof google !== 'undefined') {
      // åŒæ­¥æ›´æ–°é ‚éƒ¨æ§åˆ¶å°
      google.script.run.withSuccessHandler(renderGroupControl).getActiveGroups();
      
      // åŒæ­¥æ›´æ–°ä¸‹æ–¹è¨‚å–®æ¸…å–®
      google.script.run.withSuccessHandler(orders => {
        allAdminOrders = orders || [];
        renderOrderList();
      }).getAllOrdersForAdmin();
    }
  }
  /**
   * 2. æ¸²æŸ“é ‚éƒ¨æ§åˆ¶å° (å„ªåŒ–ç‰ˆï¼šéš±è—å·²çµæŸã€ä¸‹æ‹‰é¸å–®ç¾åŒ–)
   */
  // å®šç¾©å…¨åŸŸè®Šæ•¸ä¾†å­˜å„²æœ€å¾Œä¸€æ¬¡æŠ“å–çš„åœ˜å‹™è³‡æ–™
  let lastGroupsData = [];

  function renderGroupControl(groups) {
    if (groups) lastGroupsData = groups; 
    const container = document.getElementById('groupStatusControlContainer');
    const hideFinished = document.getElementById('hideFinishedGroups').checked;
    const statusOptions = ["åœ˜å‹™é€²è¡Œä¸­", "å·²æ”¶å–®", "å®˜æ–¹å‡ºè²¨ä¸­", "åˆ°é›†é‹", "é‹å›ä¸­", "æŠµå°å¯„å‡ºä¸­", "åœ˜å‹™çµæŸ"];
    
    if (!lastGroupsData || lastGroupsData.length === 0) {
      container.innerHTML = "<div class='text-slate-300 text-xs text-center col-span-2 py-4'>å°šç„¡åœ˜å‹™è³‡æ–™</div>";
      return;
    }

    let htmlContent = "";
    lastGroupsData.forEach(g => {
      const isFinished = (g.status === "åœ˜å‹™çµæŸ");
      
      // éš±è—çµæŸåœ˜å‹™é‚è¼¯
      if (hideFinished && isFinished) return;

      const groupColor = getThemeColor(g.name);
      const grayscaleStyle = isFinished ? 'filter: grayscale(1); opacity: 0.5; background: #f8fafc;' : 'background: white;';

      // --- ğŸ’¡ æ ¸å¿ƒé‚è¼¯ï¼šåˆ¤æ–·åº•ä¸‹è¦é¡¯ç¤ºä»€éº¼æ–‡å­— ---
      let subText = "";
      if (g.status === "åœ˜å‹™é€²è¡Œä¸­") {
        // é¡¯ç¤ºæ”¶å–®æ™‚é–“ï¼Œåªæˆªå–æœˆ/æ—¥ æ™‚:åˆ† è®“ä»‹é¢æ›´ç²¾ç°¡
        const d = g.deadlineStr ? g.deadlineStr.toString().replace('T', ' ') : "æœªè¨­å®š";
        subText = `â° æ”¶å–®ï¼š${d}`;
      } 
      else if (["å·²æ”¶å–®", "å®˜æ–¹å‡ºè²¨ä¸­", "åˆ°é›†é‹", "é‹å›ä¸­", "æŠµå°å¯„å‡ºä¸­"].includes(g.status)) {
        // é¡¯ç¤ºå®˜æ–¹å‡ºè²¨æ™‚é–“
        subText = `ğŸ“¦ å‡ºè²¨ï¼š${g.shippingTime || "å¾…æ›´æ–°"}`;
      } 
      else if (isFinished) {
        // åœ˜å‹™çµæŸï¼šä¸é¡¯ç¤º
        subText = "&nbsp;"; 
      }

      htmlContent += `
        <div class="flex items-center justify-between p-3 rounded-2xl border border-slate-100 shadow-sm transition-all" 
            style="${grayscaleStyle}">
          <div class="flex flex-col overflow-hidden mr-2">
            <span class="font-black text-slate-700 text-[11px] truncate ${isFinished ? 'line-through' : ''}">${g.name}</span>
            <span class="text-[9px] font-bold text-slate-400 truncate">${subText}</span>
          </div>
          <select onchange="changeGroupStatusByName('${g.name}', this.value)" 
                  class="status-select-mini font-bold border-2 rounded-lg px-1 py-1 bg-white outline-none cursor-pointer"
                  style="border-color: ${isFinished ? '#cbd5e1' : groupColor}; color: ${isFinished ? '#64748b' : groupColor};">
            ${statusOptions.map(opt => `<option value="${opt}" ${g.status === opt ? 'selected' : ''}>${opt}</option>`).join('')}
          </select>
        </div>
      `;
    });

    container.innerHTML = htmlContent || "<div class='text-slate-300 text-xs text-center col-span-2 py-4 italic'>ç›®å‰æ²’æœ‰é€²è¡Œä¸­çš„åœ˜å‹™</div>";
  }
  
  function getThemeColor(groupName) {
    const name = (groupName || "").toUpperCase();
    if (themeMap['GG'].keywords.some(k => name.includes(k.toUpperCase()))) return '#FF84C3'; // å°‘å¥³æ™‚ä»£ç²‰
    if (themeMap['NCT'].keywords.some(k => name.includes(k.toUpperCase()))) return '#B0CF00'; // NCT è‰ç¶ 
    if (themeMap['RZ'].keywords.some(k => name.includes(k.toUpperCase()))) return '#FF9E23'; // RIIZE æ©˜
    if (themeMap['SM'].keywords.some(k => name.includes(k.toUpperCase()))) return '#FCE0E4'; // SM ç²‰ç™½
    return '#6366f1'; // é è¨­é›è—è‰²
  }

  function renderOrderList() {
    const listDiv = document.getElementById('adminOrderList');
    if (!allAdminOrders || allAdminOrders.length === 0) {
      listDiv.innerHTML = "<div class='text-center py-10 text-slate-400 font-bold'>ç›®å‰å°šç„¡è¨‚å–®è³‡æ–™</div>";
      return;
    }

    const sortedOrders = [...allAdminOrders].sort((a, b) => 
      (a.groupName || "").localeCompare(b.groupName || "")
    );

    let htmlContent = "";
    let lastGroup = "";

    sortedOrders.forEach(o => {
      // ç•¶ç™¼ç¾æ˜¯æ–°çš„ä¸€çµ„åœ˜å‹™æ™‚ï¼Œæ‰æ’å…¥ä¸€æ¬¡æ¨™é¡Œèˆ‡é¸å–®
      if (o.groupName !== lastGroup) {
        lastGroup = o.groupName;
        const groupColor = getThemeColor(o.groupName);
        
        htmlContent += `
          <div class="group-header mt-8 mb-3 flex items-center">
            <div class="h-[2px] flex-1" style="background-color: ${groupColor}44"></div>
            <span class="mx-3 px-5 py-1.5 text-white text-xs font-black rounded-full shadow-sm" style="background-color: ${groupColor}">
              ${o.groupName || 'æœªåˆ†é¡åœ˜å‹™'}
            </span>
            <div class="h-[2px] flex-1" style="background-color: ${groupColor}44"></div>
          </div>`;
      }

      // --- ä»¥ä¸‹æ˜¯å–®ç­†è¨‚å–®å¡ç‰‡ï¼Œç¶­æŒåŸæ¨£ ---
      const isVerified = o.status === 'å·²æ ¸å°';
      const groupColor = getThemeColor(o.groupName);
      const statusClass = isVerified ? 'bg-slate-50 opacity-80' : 'bg-white shadow-sm';

      let remitDisplay = "";
      if (o.remitCode) {
        remitDisplay = `<span class="text-[10px] bg-indigo-600 text-white px-2 py-0.5 rounded-md font-bold shadow-sm ring-2 ring-indigo-100 italic">ğŸ¦ ${o.remitCode}</span>`;
      } else if (!isVerified) {
        remitDisplay = `<span class="text-[10px] bg-slate-100 text-slate-400 px-2 py-0.5 rounded-md font-bold">å¾…å¡«æœ«äº”ç¢¼</span>`;
      }

      htmlContent += `
        <div class="order-card admin-order-item cursor-pointer active:scale-95 transition-all border-2 ${statusClass}" 
            onclick="toggleOrderStatus(${o.rowIndex}, '${o.status}', '${o.lineName}')"
            style="border-color: ${isVerified ? '#e2e8f0' : groupColor + '88'}"
            data-status="${o.status}" 
            data-search="${((o.groupName || '') + (o.lineName || '') + (o.contact || '') + (o.email || '') + (o.remitCode || '')).toLowerCase()}">
          <div class="flex justify-between items-start">
            <div>
              <div class="flex items-center gap-2">
                <p class="font-black text-lg text-slate-800">${o.lineName || 'æœªçŸ¥'}</p>
                ${remitDisplay}
              </div>
              <p class="text-[10px] text-slate-400 font-medium truncate max-w-[200px]">${o.email || 'ç„¡ Email'}</p>
            </div>
            <span class="text-[10px] font-black px-3 py-1 rounded-full ${isVerified ? 'bg-green-500 text-white' : 'text-white animate-pulse'}"
                  style="${!isVerified ? 'background-color:' + groupColor : ''}">
              ${isVerified ? 'âœ“ ' + o.status : 'â— ' + o.status}
            </span>
          </div>
          <div class="my-3 text-xs text-slate-600 bg-white bg-opacity-60 p-2 rounded-lg border border-slate-100 whitespace-pre-line">${o.detail || ''}</div>
          <div class="flex justify-between items-center font-black">
            <div class="flex items-center gap-1">
              <span class="text-[9px] bg-slate-200 text-slate-600 px-1.5 py-0.5 rounded">ID</span>
              <span class="text-[11px] text-slate-500">${o.contact || 'ç„¡'}</span>
            </div>
            <span style="color: ${groupColor}">NT$ ${o.total || 0}</span>
          </div>
        </div>`;
    });

    listDiv.innerHTML = htmlContent;
    filterOrders();
  }

  /**
   * 3. åˆ‡æ›ã€Œåœ˜å‹™ç®¡ç†ã€å·¥ä½œè¡¨ç‹€æ…‹ (E æ¬„)
   */
  function changeGroupStatusByName(groupName, newStatus) {
    if (!confirm("ç¢ºå®šè¦å°‡ã€" + groupName + "ã€‘æ›´æ–°ç‚ºï¼š" + newStatus + "ï¼Ÿ")) return;
    
    if (typeof google !== 'undefined') {
      google.script.run.withSuccessHandler(res => {
        if (res.success) loadAdminOrders(); // æˆåŠŸå¾Œåˆ·æ–°å…¨éƒ¨
        else alert("æ›´æ–°å¤±æ•—ï¼š" + res.error);
      }).updateGroupStatusByName(groupName, newStatus);
    }
  }

  /**
   * 4. åˆ‡æ›ã€Œè¨‚å–®è³‡æ–™ã€æ ¸å°ç‹€æ…‹ (H æ¬„)
   */
  function toggleOrderStatus(rowIndex, currentStatus, name) {
    const targetCard = event.currentTarget;
    if (targetCard.style.pointerEvents === 'none') return;
    targetCard.style.pointerEvents = 'none';

    if (typeof google !== 'undefined') {
      google.script.run.withSuccessHandler(res => {
        targetCard.style.pointerEvents = 'auto';
        if (res.success) {
          // ç›´æ¥æ›´æ–° UIï¼Œä¸é‡æ–°æ¸²æŸ“æ•´é ä»¥ä¿æŒæµæš¢åº¦
          const isNowVerified = (res.newStatus === 'å·²æ ¸å°');
          targetCard.setAttribute('data-status', res.newStatus);
          targetCard.setAttribute('onclick', `toggleOrderStatus(${rowIndex}, '${res.newStatus}', '${name}')`);
          
          // é‡æ–°è·‘ä¸€æ¬¡ç¯©é¸ï¼Œè‹¥æœ‰å‹¾é¸ã€Œéš±è—å·²æ ¸å°ã€è©²å¡ç‰‡æœƒæ¶ˆå¤±
          filterOrders();
        }
      }).toggleOrderStatus(rowIndex, currentStatus);
    }
  }

  /**
   * 5. æœå°‹èˆ‡éš±è—é‚è¼¯ (å«å‹•ç•«æ•ˆæœ)
   */
  function filterOrders() {
    const term = document.getElementById('orderSearchInput').value.toLowerCase();
    const hideChecked = document.getElementById('hideCheckedVerify').checked;
    
    document.querySelectorAll('.admin-order-item').forEach(card => {
      const isVerified = (card.getAttribute('data-status') === 'å·²æ ¸å°');
      const matchesSearch = card.getAttribute('data-search').includes(term);
      
      if (matchesSearch && !(hideChecked && isVerified)) {
        card.style.display = "block";
        setTimeout(() => card.style.opacity = "1", 10);
      } else {
        card.style.opacity = "0";
        setTimeout(() => card.style.display = "none", 400); 
      }
    });
  }

  function saveToSheet() {
    let prods = [];
    document.querySelectorAll('#itemBody tr').forEach(r => {
      const n = r.querySelector('.p-name').value;
      if(n) {
        prods.push({ 
          groupId: currentGroupId, 
          name: n, 
          twd: r.querySelector('.p-twd').value, 
          foreign: r.querySelector('.p-foreign').value, 
          master: r.querySelector('.p-cost').value, 
          profit: r.querySelector('.p-profit').value 
        });
      }
    });
    if(typeof google !== 'undefined') {
      google.script.run.withSuccessHandler(() => alert("åŒæ­¥æˆåŠŸ")).batchAddProducts(prods);
    }
  }
</script>
</body>
</html>
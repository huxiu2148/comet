<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap');
    body { font-family: 'Noto Sans TC', sans-serif; background-color: #f8fafc; padding: 16px; }
    .group-card { background: white; border-radius: 24px; padding: 20px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); margin-bottom: 16px; border: 2.5px solid #e2e8f0; }
    .is-closed { opacity: 0.5; filter: grayscale(1); pointer-events: none; background: #f1f5f9; }
    .border-GG { border-color: #FF84C3; } .border-NCT { border-color: #E1E668; } .border-RZ { border-color: #FF9E23; } .border-SM { border-color: #FCE0E4; } .border-OTH { border-color: #E2E8F0; }
    .btn-qty { width: 34px; height: 34px; border-radius: 10px; background: #f1f5f9; display: flex; align-items: center; justify-content: center; font-weight: 900; }
    .spec-select, .spec-input { width: 100%; height: 40px; background: #f8fafc; border: 2px solid #edf2f7; border-radius: 12px; font-size: 14px; padding: 0 10px; margin-top: 10px; outline: none; }
    .input-field { width: 100%; height: 50px; background: #f1f5f9; border-radius: 14px; font-size: 15px; outline: none; border: 2px solid transparent; padding: 0 16px; }
    #bankModal { 
      display: none; 
      position: fixed; 
      inset: 0; 
      background: rgba(0,0,0,0.6); 
      align-items: center; 
      justify-content: center; 
      z-index: 60; /* é€™è£¡èª¿é«˜ */
      padding: 20px; 
    }
    #historyModal { 
      display: none; 
      position: fixed; 
      inset: 0; 
      background: rgba(0,0,0,0.6); 
      align-items: center; 
      justify-content: center; 
      z-index: 50; 
      padding: 20px; 
    }
    .modal-content { background: white; border-radius: 32px; padding: 28px; width: 100%; max-width: 400px; max-height: 85vh; overflow-y: auto; position: relative; }
    .close-x { position: absolute; top: 20px; right: 20px; width: 32px; height: 32px; background: #f1f5f9; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 18px; font-weight: bold; color: #94a3b8; cursor: pointer; }
    /* è®“å›å ±è¼¸å…¥æ¡†çš„å±¤ç´šé«˜æ–¼è³‡è¨Šè¦–çª— */
    #remitInputModal {
      z-index: 9999 !important; /* æ•¸å­—è¶Šå¤§ä»£è¡¨è¶Šå‰é¢ */
    }

    /* ç¢ºä¿è³‡è¨Šè¦–çª—çš„å±¤ç´šç¨å¾®ä½ä¸€é» */
    #historyDetailModal {
      z-index: 9990 !important;
    }

    /* é®ç½©èƒŒæ™¯ä¹Ÿè¦èª¿æ•´ï¼Œç¢ºä¿ä¸æœƒç–Šåœ¨ä¸€èµ·è®Šå¤ªé»‘ */
    .modal-overlay {
      z-index: 9980;
    }
  </style>
</head>
<body onload="initOrderPage()">

  <div id="bankModal">
    <div class="modal-content shadow-2xl text-center">
      <div class="w-12 h-12 bg-green-100 text-green-600 rounded-full flex items-center justify-center mx-auto mb-4">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>
      </div>
      <div id="modalContentBody"></div>
      <button onclick="resetAndGoHome()" class="w-full h-14 bg-slate-900 text-white rounded-2xl font-black shadow-lg active:scale-95 transition-transform mt-6">é—œé–‰ä¸¦è¿”å›ä¸»é </button>
    </div>
  </div>

  <div id="historyModal">
    <div class="modal-content">
      <div class="close-x" onclick="document.getElementById('historyModal').style.display='none'">âœ•</div>
      <h2 class="text-xl font-black text-slate-800 mb-6 text-center">æˆ‘çš„è¨‚å–®ç´€éŒ„</h2>
      
      <div id="historySearchArea" class="mb-6 p-4 bg-slate-50 rounded-2xl border border-slate-100">
        <p class="text-[10px] font-black text-slate-400 mb-2 uppercase ml-1">åˆ‡æ› Email æŸ¥è©¢</p>
        <div class="flex gap-2">
          <input type="email" id="historyEmailSearch" class="input-field !h-11 !text-sm" placeholder="è¼¸å…¥å…¶ä»– Email">
          <button onclick="manualSearchHistory()" class="bg-indigo-500 text-white px-4 rounded-xl font-bold text-xs whitespace-nowrap">æŸ¥è©¢</button>
        </div>
      </div>

      <div id="historyList" class="space-y-4 text-left"></div>
    </div>
  </div>

  <div class="max-w-[500px] mx-auto pb-24">
    <div id="homePage">
      <div class="text-center my-10">
        <h1 class="text-4xl font-black text-slate-900 tracking-tighter">COMETå°å°ä»£è³¼ğŸ’«ğŸ’Ÿ</h1>
        <button onclick="showHistory()" class="mt-6 px-5 py-2.5 bg-white border-2 border-slate-100 rounded-full text-xs font-black text-indigo-500 shadow-sm">æŸ¥è©¢æˆ‘çš„ä¸‹å–®ç´€éŒ„</button>
      </div>
      <div id="groupList" class="space-y-4">è¼‰å…¥ä¸­...</div>
    </div>

    <div id="calculatorView" class="hidden">
      <div class="flex justify-between items-center mb-6">
        <div class="text-slate-400 font-bold cursor-pointer text-sm" onclick="goBackToList()">â† è¿”å›åˆ—è¡¨</div>
        <button id="detailBankBtn" onclick="showBankModal()" class="hidden px-3 py-1.5 bg-indigo-50 text-indigo-500 rounded-full text-[11px] font-black border border-indigo-100">æŸ¥çœ‹è³‡è¨Š</button>
      </div>
      <div id="calcContainer"></div>
    </div>
  </div>
  <div id="remitInputModal" style="display: none;" class="fixed inset-0 bg-black/60 z-[100] items-center justify-center p-5">
    <div class="modal-content !max-w-[350px]">
      <h3 id="remitModalTitle" class="text-lg font-black text-slate-800 mb-4 text-center">å¡«å¯«è³‡è¨Š</h3>
      
      <div class="space-y-4">
        <div id="bankSelectGroup">
          <p class="text-[10px] font-black text-slate-400 mb-1 ml-1 uppercase">åŒ¯å…¥éŠ€è¡Œ</p>
          <select id="bankSelect" class="spec-select !m-0">
            <option value="åœ‹æ³°">åœ‹æ³° (013)</option>
            <option value="æ°¸è±">æ°¸è± (807)</option>
            <option value="ä¸­ä¿¡">ä¸­ä¿¡ (822)</option>
          </select>
        </div>
        
        <div>
          <p id="inputLabel" class="text-[10px] font-black text-slate-400 mb-1 ml-1 uppercase">å¸³æˆ¶æœ«äº”ç¢¼</p>
          <input type="text" id="lastFiveInput" class="input-field !h-12" placeholder="è«‹è¼¸å…¥ 5 ç¢¼æ•¸å­—">
        </div>
        
        <div class="flex gap-3 mt-6">
          <button onclick="closeRemitModal()" class="flex-1 h-12 bg-slate-100 text-slate-500 rounded-xl font-bold text-sm">å–æ¶ˆ</button>
          <button id="submitRemitBtn" class="flex-1 h-12 bg-indigo-500 text-white rounded-xl font-bold text-sm">ç¢ºèªæäº¤</button>
        </div>
      </div>
    </div>
  </div>

<script>
  var themeColors = { 'SNSD': '#FF84C3','GG': '#FF84C3', 'NCT': '#B0CF00', 'RZ': '#FF9E23', 'SM': '#FCE0E4', 'OTH': '#6366f1' };
  var runningTotal = 0, savedInfo = {lineName: "", contact: "", userEmail: ""}, currentMode = "3";
  var lastPassportName = "";

  function initOrderPage() {
    google.script.run.withSuccessHandler(function(info) { 
      if (info) {
        savedInfo = {
          lineName: (info.lineName && info.lineName !== "undefined") ? info.lineName : "",
          contact: (info.contact && info.contact !== "undefined") ? info.contact : "",
          userEmail: (info.userEmail && info.userEmail !== "undefined") ? info.userEmail : "" 
        };
      }
      loadGroups(); 
    }).getUserInfo();
  }

  function loadGroups() {
    google.script.run.withSuccessHandler(function(groups) {
      var container = document.getElementById('groupList');
      if (!groups || groups.length === 0) { container.innerHTML = "ç›®å‰æš«ç„¡é–‹åœ˜ä¸­"; return; }
      
      var html = "";
      for (var i = 0; i < groups.length; i++) {
        var g = groups[i];
        var type = g.id ? g.id.split('-')[0] : 'OTH';
        var statusColors = {
          'åœ˜å‹™é€²è¡Œä¸­': 'bg-green-400', 'å·²æ”¶å–®': 'bg-red-300', 'å®˜æ–¹å‡ºè²¨ä¸­': 'bg-blue-200',
          'åˆ°é›†é‹': 'bg-purple-200', 'é‹å›ä¸­': 'bg-sky-200', 'æŠµå°å¯„å‡ºä¸­': 'bg-orange-200', 'åœ˜å‹™çµæŸ': 'bg-gray-300'
        };
        var barColor = statusColors[g.status] || 'bg-slate-200';
        
        // âœ¨ ç°¡åŒ–å¾Œçš„é»æ“Šé‚è¼¯åˆ¤æ–·
        var clickAction = "";
        if (g.mode === "4" && g.link) {
          // æ”¹ç‚ºå‘¼å«å°ˆé–€çš„å‡½æ•¸ï¼Œå‚³å…¥é€£çµå³å¯
          clickAction = "handleMode4('" + g.link + "')";
        } else if (g.canOrder) {
          clickAction = "selectGroup('" + g.id + "', '" + g.name + "', '" + type + "', '" + g.mode + "', '" + g.deadlineStr + "', '" + g.shippingTime + "')";
        } else {
          clickAction = "alert('æ­¤åœ˜å‹™ç›®å‰ç‹€æ…‹ç‚ºã€" + g.status + "ã€‘ï¼Œå·²ä¸é–‹æ”¾ä¸‹å–®ã€‚')";
        }

        html += '<div onclick="' + clickAction + '" class="group-card border-' + type + ' ' + (!g.canOrder ? 'opacity-90' : 'cursor-pointer active:scale-95') + '">' +
                '<div class="flex justify-between items-start mb-2">' +
                '<div><h3 class="text-xl font-black text-slate-800">' + g.name + '</h3>' +
                '<p class="text-[10px] text-slate-400 font-bold uppercase tracking-wider">æˆªæ­¢ï¼š' + g.deadlineStr + '</p></div>' +
                '<span class="text-[10px] font-black px-2 py-1 rounded-full ' + (g.canOrder ? 'bg-green-100 text-green-600' : 'bg-slate-100 text-slate-500') + '">' + g.status + '</span></div>' +
                '<div class="w-full bg-slate-100 h-1.5 rounded-full mt-3 overflow-hidden">' +
                '<div class="' + barColor + ' h-full transition-all duration-500" style="width: ' + getProgressWidth(g.status) + '%"></div></div></div>';
      }
      container.innerHTML = html;
    }).getActiveGroups();
  }
  // ğŸš€ æ¨¡å¼ 4 å°ˆç”¨è·³è½‰åŠ©æ‰‹
  function handleMode4(url) {
    // é€™è£¡å¯«å¦³æƒ³è¦çš„å®Œæ•´æé†’æ–‡å­—ï¼Œä¸ç”¨æ“”å¿ƒæ–œç·šå•é¡Œ
    var msg = "ä¸‹å–®æˆåŠŸï¼ğŸ’«\n\nå·²ç‚ºæ‚¨é–‹å•Ÿè³£è²¨ä¾¿é€£çµï¼ğŸ’Ÿ";
    
    alert(msg);
    window.open(url, '_blank');
  }

  function getProgressWidth(status) {
    var steps = ['åœ˜å‹™é€²è¡Œä¸­', 'å·²æ”¶å–®', 'å®˜æ–¹å‡ºè²¨ä¸­', 'åˆ°é›†é‹', 'é‹å›ä¸­', 'æŠµå°å¯„å‡ºä¸­', 'åœ˜å‹™çµæŸ'];
    var idx = steps.indexOf(status);
    return idx === -1 ? 10 : ((idx + 1) / steps.length) * 100;
  }

  function selectGroup(id, name, type, mode, deadlineStr, shippingTime) {
    currentMode = mode;
    document.getElementById('detailBankBtn').classList.add('hidden');
    document.getElementById('calcContainer').innerHTML = "<div class='py-20 text-center text-slate-400 font-bold'>è®€å–ä¸­...</div>";
    window.currentGroupId = id; 
    window.currentGroupName = name; 
    runningTotal = 0;
    
    document.getElementById('homePage').classList.add('hidden');
    document.getElementById('calculatorView').classList.remove('hidden');
    
    // ä¿®æ”¹é€™å€‹æˆåŠŸå›å‘¼å‡½æ•¸
    google.script.run.withSuccessHandler(function(res) { 
      if(res && res.hasOrder) {
        document.getElementById('detailBankBtn').classList.remove('hidden');
        // ã€é—œéµã€‘å­˜å…¥å…¨åŸŸè®Šæ•¸ï¼Œé€™æ¨£é»æ“Šã€ŒæŸ¥çœ‹è³‡è¨Šã€æ™‚æ‰æŠ“å¾—åˆ°è¡Œè™Ÿ
        window.lastOrderRowIndex = res.rowIndex; 
      }
    }).checkOrderAuth(id);

    google.script.run.withSuccessHandler(function(products) {
      window.currentProducts = products;
      var color = themeColors[type] || '#6366f1';
      var productHtml = "";
      for (var i = 0; i < products.length; i++) {
        var p = products[i];
        var cleanName = p.name.split('(')[0].trim();
        productHtml += '<div class="pb-4 border-b border-slate-50 last:border-0">' +
                       '<div class="flex justify-between items-start"><div class="flex-1 pr-4">' +
                       '<p class="font-bold text-slate-700 text-sm">' + cleanName + '</p>' +
                       '<p class="font-black text-xs" style="color:' + color + '">NT$ ' + p.price + '</p></div>' +
                       '<div class="flex items-center gap-3"><button onclick="updateQty(' + i + ', -1, ' + p.price + ')" class="btn-qty">-</button>' +
                       '<span id="qty-' + i + '" class="font-black w-6 text-center">0</span>' +
                       '<button onclick="updateQty(' + i + ', 1, ' + p.price + ')" class="btn-qty">+</button></div></div>' +
                       parseProductUI(p.name, i) + '</div>';
      }

      var containerHtml = '<div class="group-card border-' + type + '">' +
        '<h2 class="text-2xl font-black mb-4 text-slate-800">' + name + '</h2>' +
        '<div class="bg-slate-50 rounded-2xl p-4 mb-6 text-[13px] font-bold text-slate-500 space-y-2 border border-slate-100">' +
        '<p class="flex justify-between"><span>â³ æ”¶å–®æˆªæ­¢</span> <span class="text-slate-800">' + deadlineStr + '</span></p>' +
        '<p class="flex justify-between"><span>ğŸ“¦ å®˜æ–¹å‡ºè²¨</span> <span class="text-slate-800">' + shippingTime + '</span></p></div>' +
        '<div class="space-y-4 mb-8 text-left">' +
        '<div><p class="text-[10px] font-black text-slate-400 mb-1 ml-1 uppercase">å¸¸ç”¨é›»å­éƒµä»¶</p><input type="email" id="uEmail" class="input-field" value="' + (savedInfo.userEmail || '') + '"></div>' +
        '<div><p class="text-[10px] font-black text-slate-400 mb-1 ml-1 uppercase">è¯çµ¡å¸³è™Ÿ (FB/IG)</p><input type="text" id="cID" class="input-field" value="' + (savedInfo.contact || '') + '"></div>' +
        '<div><p class="text-[10px] font-black text-slate-400 mb-1 ml-1 uppercase">LINEç¤¾ç¾¤æš±ç¨±</p><input type="text" id="lName" class="input-field" value="' + (savedInfo.lineName || '') + '"></div>' +
        (currentMode === "2" ? '<div id="passportBox"><p class="text-[10px] font-black text-rose-500 mb-1 ml-1 uppercase">è­·ç…§è‹±æ–‡å§“å</p><input type="text" id="passportName" class="input-field border-rose-100" placeholder="WANG XIAO MING"></div>' : '') +
        '</div><div class="space-y-6 mb-8 pt-6 border-t border-slate-100 text-left">' + productHtml + '</div>' +
        '<div class="mt-8 p-6 rounded-[2rem] text-center" style="background:' + color + '10"><p id="totalDisplay" class="text-4xl font-black" style="color:' + color + '">NT$ 0</p></div>' +
        '<button onclick="submitOrder(\'' + color + '\')" id="sBtn" class="w-full h-14 rounded-2xl text-white font-black mt-6 shadow-lg" style="background:' + color + '">ç¢ºèªä¸‹å–® ğŸš€</button></div>';
      
      document.getElementById('calcContainer').innerHTML = containerHtml;
    }).getGroupProducts(id);
  }

  function parseProductUI(fullName, index) {
    // 1. ä½¿ç”¨æ­£å‰‡æŠ“å–æ‹¬è™Ÿå…§å®¹
    var match = fullName.match(/\(([^)]+)\)/);
    if (!match) return ""; 
    
    var content = match[1]; // é€™æ˜¯æ‹¬è™Ÿå…§çš„æ–‡å­—
    var html = '<p class="text-[10px] text-indigo-500 mt-1 font-bold">èªªæ˜ï¼š' + content + '</p>';
    
    // 2. åˆ¤æ–·æ˜¯å¦åŒ…å«é—œéµå­—ï¼šåˆ†ã€æŒ‘ã€é¸ã€å¡« æˆ– æ–œç·š /
    // ä½¿ç”¨æ­£å‰‡è¡¨é”å¼ /[åˆ†æŒ‘é¸å¡«\/]/ é€²è¡Œæª¢æŸ¥
    var needInput = /[åˆ†æŒ‘é¸å¡«\/]/.test(content);
    
    if (needInput) {
      html += '<input type="text" id="spec-input-' + index + '" class="spec-input" placeholder="è«‹ä¾ç…§èªªæ˜å¡«å¯«å…§å®¹">';
    }
    
    return html;
  }

  function updateQty(i, d, p) {
    var qEl = document.getElementById('qty-' + i);
    var q = parseInt(qEl.innerText) + d; if (q < 0) return;
    qEl.innerText = q; runningTotal += (d * p);
    document.getElementById('totalDisplay').innerText = 'NT$ ' + runningTotal.toLocaleString();
  }

  function submitOrder(color) {
    var ue = document.getElementById('uEmail').value.trim(), 
        ln = document.getElementById('lName').value.trim(), 
        ct = document.getElementById('cID').value.trim();
        
    if (!ue || !ln || !ct || runningTotal === 0) return alert("è«‹å®Œæ•´å¡«å¯«è³‡è¨Šä¸¦é¸æ“‡å•†å“ï¼");
    if (ue.indexOf('@gmail.com') === -1) return alert("è«‹å¡«å¯«æ­£ç¢ºçš„ Gmailï¼");

    var passportName = "";
    if (currentMode === "2") {
        passportName = document.getElementById('passportName').value.trim();
        if (!passportName) return alert("è«‹å‹™å¿…å¡«å¯«è­·ç…§è‹±æ–‡å§“åï¼");
        lastPassportName = passportName;
    }

    var det = [], validationError = "";
    for (var i = 0; i < window.currentProducts.length; i++) {
        var p = window.currentProducts[i];
        var qty = parseInt(document.getElementById('qty-' + i).innerText) || 0;
        if (qty > 0) {
            var cleanName = p.name.split('(')[0].trim();
            var inpEl = document.getElementById('spec-input-' + i);
            if (inpEl) {
                var specValue = inpEl.value.trim();
                if (specValue === "") { 
                    validationError = "è«‹å¡«å¯«å•†å“ã€Œ" + cleanName + "ã€çš„è¦æ ¼å…§å®¹ï¼"; 
                    break; 
                }
                det.push(cleanName + " [" + specValue + "] x" + qty);
            } else {
                det.push(cleanName + " x" + qty);
            }
        }
    }
    if (validationError !== "") return alert(validationError);
    if (passportName) det.unshift("ã€è­·ç…§å§“åï¼š" + passportName + "ã€‘");

    var btn = document.getElementById('sBtn'); 
    if (btn.disabled) return; 
    btn.disabled = true; 
    btn.style.opacity = "0.5"; 
    btn.innerText = "å‚³é€ä¸­...";
    
    // âœ¨ é€™è£¡æ˜¯æ­£ç¢ºçš„ google.script.run å¯«æ³•
    google.script.run.withSuccessHandler(function(res) { 
        if (res.success) {
            window.lastOrderRowIndex = res.rowIndex;

            // 1. å„²å­˜ä¸¦è¨˜ä½ä½¿ç”¨è€…è³‡æ–™
            savedInfo = {lineName: ln, contact: ct, userEmail: ue};
            localStorage.setItem('comet_user_info', JSON.stringify(savedInfo));

            // 2. åˆ¤æ–·æ¨¡å¼
            if (currentMode === "4") {
                // æ¨¡å¼ 4ï¼šè·³å‡ºè³£è²¨ä¾¿å°ˆå±¬æç¤ºä¸¦è·³è½‰
                alert("ä¸‹å–®æˆåŠŸï¼ğŸ’«\n\nå·²ç‚ºæ‚¨é–‹å•Ÿè³£è²¨ä¾¿é€£çµï¼ğŸ’Ÿ");
                window.open(currentLink, '_blank');
                closeOrderModal();
            } else {
                // æ¨¡å¼ 1, 2, 3ï¼šé¡¯ç¤ºéŠ€è¡Œ/é›†é‹è³‡è¨Šå½ˆçª—
                showBankModal();
                var detailBtn = document.getElementById('detailBankBtn');
                if (detailBtn) detailBtn.classList.remove('hidden'); 
                
                alert("ä¸‹å–®æˆåŠŸï¼å‰¯æœ¬å·²å¯„é€è‡³ä¿¡ç®± ğŸ’«");
                closeOrderModal();
            }
            
            // 3. æ¢å¾©æŒ‰éˆ•ç‹€æ…‹
            btn.disabled = false; 
            btn.style.opacity = "1";
            btn.innerText = "ç¢ºèªä¸‹å–® ğŸš€";
            if (typeof loadGroups === "function") loadGroups();
        } else {
            alert("ä¸‹å–®å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚");
            btn.disabled = false;
            btn.style.opacity = "1";
            btn.innerText = "ç¢ºèªä¸‹å–® ğŸš€";
        }
    }).submitOrderToSheet({
        groupId: window.currentGroupId, 
        groupName: window.currentGroupName, 
        lineName: ln, 
        contact: ct, 
        userEmail: ue, 
        detail: det.join('\n'), 
        total: runningTotal,
        mode: currentMode // âœ¨ è¨˜å¾—å‚³å…¥ mode çµ¦å¾Œç«¯ï¼Œé€™æ¨£å¾Œç«¯æ‰èƒ½åˆ†æµ Telegram å’Œå¯„ä¿¡
    });
}
// å…¨åŸŸè®Šæ•¸
window.isFromHistory = false;
window.currentGroupLink = "";

/**
 * ä¿®æ­£å¾Œçš„æ­·å²ç´€éŒ„è©³æƒ…é¡¯ç¤ºå‡½æ•¸
 * ç¢ºä¿åƒæ•¸åˆ—åŒ…å« rowIndexï¼Œä¸¦æ­£ç¢ºè™•ç†å½ˆçª—é¡¯ç¤º
 */
function showHistory() {
  // 1. å…ˆå¾ localStorage æŠ“å‡ºæ•´åŒ…å­—ä¸²ï¼Œä¸¦è½‰å›ç‰©ä»¶
  var rawData = localStorage.getItem('comet_user_info');
  var memory = rawData ? JSON.parse(rawData) : null;
  
  // 2. å–å¾— Email (å„ªå…ˆç”¨è¨˜æ†¶çš„ï¼Œæ²’æœ‰å°±ç”¨è®Šæ•¸è£¡çš„)
  var emailToSearch = (memory && memory.userEmail) ? memory.userEmail : savedInfo.userEmail;
  
  document.getElementById('historyModal').style.display = 'flex';
  
  var searchInput = document.getElementById('historyEmailSearch');
  if (searchInput) {
    // å¡«å…¥ Email ä½†ä¿ç•™è¼¸å…¥æ¡†
    searchInput.value = emailToSearch || ""; 
    
    // å¦‚æœæœ‰ Emailï¼Œå°±ç›´æ¥è‡ªå‹•å¹«ä»–æŸ¥è©¢
    if (emailToSearch) {
      fetchHistory(emailToSearch);
    }
  }
}
function showHistoryDetail(mode, passport, link, rowIndex) {
  window.isFromHistory = true;
  currentMode = mode.toString();
  lastPassportName = passport;
  window.currentGroupLink = link || "";
  window.lastOrderRowIndex = rowIndex;

  var bankModal = document.getElementById('bankModal');
  if (bankModal) {
    bankModal.style.zIndex = "200";
    showBankModal();
  }
}

// âœ… éœ€æ±‚ 3ï¼šæ‰‹å‹•æŸ¥è©¢åŠŸèƒ½
function manualSearchHistory() {
  const email = document.getElementById('historyEmailSearch').value.trim();
  if (!email || !email.includes('@gmail.com')) return alert("è«‹è¼¸å…¥æ­£ç¢ºçš„ Gmail");
  
  // æ›´æ–°è¨˜æ†¶ç‰©ä»¶ä¸­çš„ Email
  savedInfo.userEmail = email;
  localStorage.setItem('comet_user_info', JSON.stringify(savedInfo));
  
  fetchHistory(email);
}

// ä¿®æ”¹å¾Œçš„ showBankModal åŠ å…¥æ¨¡å¼ 4 åˆ¤æ–·
  function showBankModal() {
    var body = document.getElementById('modalContentBody');
    var communityLink = '<div class="bg-indigo-50 rounded-2xl p-4 mt-6 border border-indigo-100 text-left"><p class="text-[10px] font-black text-indigo-400 mb-2 uppercase tracking-widest">ç¤¾ç¾¤é€£çµï¼š</p><a href="https://reurl.cc/EQ1rLk" target="_blank" class="flex items-center justify-between text-indigo-600 no-underline"><span class="text-xs font-black">åŠ å…¥ LINE ç¤¾ç¾¤å°å¸³/è¿½è¹¤</span><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line></svg></a></div>';
    
    if (currentMode === "1") {
      // ğŸ’¡ é—œéµï¼šå¾é é¢æˆ–è¨˜æ†¶ä¸­åˆ¤æ–·æ˜¯å¦æœ‰å·²å¡«å¯«çš„ç´€éŒ„
      // æˆ‘å€‘å¯ä»¥å¾ history æ¸²æŸ“æ™‚å‚³éç‹€æ…‹ï¼Œæˆ–è€…ç°¡å–®æª¢æŸ¥é é¢ä¸Šæ˜¯å¦å·²æœ‰é¡¯ç¤ºå·²å¡«æœ«äº”ç¢¼
      var hasCode = (window.lastRemitCode && window.lastRemitCode !== "");
      var btnText = hasCode ? "ä¿®æ”¹æœ«äº”ç¢¼ âœï¸" : "ç«‹å³å›å¡«æœ«äº”ç¢¼ âœï¸";

      body.innerHTML = 
        '<h2 class="text-xl font-black text-slate-800 mb-1">è¨‚å–®è³‡è¨Š</h2>' +
        '<p class="text-sm font-bold text-slate-500 mb-6">è«‹æ–¼æ”¶å–®æœŸé™å…§é€²è¡ŒåŒ¯æ¬¾</p>' +
        '<div class="bg-slate-50 rounded-2xl p-5 text-left mb-4 border border-slate-100 font-mono text-sm space-y-3">' +
          '<p class="text-[10px] font-black text-slate-400 mb-1 uppercase tracking-widest">åŒ¯æ¬¾å¸³è™Ÿï¼š</p>' +
          '<p class="select-all font-bold text-slate-700">åœ‹æ³° 013 - 699507161336</p>' +
          '<p class="select-all font-bold text-slate-700">æ°¸è± 807 - 20401800319484</p>' +
          '<p class="select-all font-bold text-slate-700">ä¸­ä¿¡ 822 - 901567858153</p>' +
        '</div>' +
        '<button onclick="openRemitFromBankModal()" class="w-full py-3 bg-indigo-500 text-white rounded-xl font-black text-sm mb-4 shadow-md">' + btnText + '</button>' +
        (hasCode ? '<p class="text-[11px] font-bold text-indigo-500 text-left px-2">â€» æ‚¨ä¹‹å‰å·²å¡«å¯«éæœ«äº”ç¢¼ï¼Œå¦‚éœ€æ›´æ”¹è«‹é»æ“Šä¸Šæ–¹æŒ‰éˆ•</p>' : '<p class="text-[11px] font-bold text-red-500 text-left px-2">â€» åŒ¯æ¬¾å®Œæˆå¾Œè«‹é»æ“Šä¸Šæ–¹æŒ‰éˆ•å›å¡«è³‡è¨Š</p>') + 
        communityLink;
    }else if (currentMode === "2") {
      var hasTracking = (window.lastRemitCode && window.lastRemitCode !== ""); // é€™è£¡æš«ç”¨åŒä¸€å€‹è®Šæ•¸å­˜å–®è™Ÿ
      var btnText = hasTracking ? "ä¿®æ”¹è¨—é‹å–®è™Ÿ ğŸšš" : "å›å ±è¨—é‹å–®è™Ÿ ğŸšš";

      body.innerHTML = `
        <h2 class="text-xl font-black text-slate-800 mb-4">å·²æ”¶åˆ°ï¼</h2>
        <div class="bg-slate-50 rounded-2xl p-4 text-left border border-slate-100 text-[13px] leading-relaxed space-y-2">
          <p class="font-black text-indigo-500 underline mb-2">é›†é‹åœ°å€å¡«å¯«å¦‚ä¸‹â¬‡ï¸</p>
          <p><b>æ”¶ä»¶äººï¼š</b> <span class="text-rose-500 font-black">${lastPassportName || '(è«‹å¡«è­·ç…§å)'}</span></p>
          <p><b>æ”¶ä»¶é›»è©±ï¼š</b> 01058182588</p>
          <p><b>åœ°å€æœå°‹ï¼š</b> (03779) ì„œìš¸íŠ¹ë³„ì‹œ ì„œëŒ€ë¬¸êµ¬ ì‹ ì´Œë¡œ 109</p>
          <p><b>è©³ç´°åœ°å€ï¼š</b> ì‹ ì´Œë¥´ë©”ì´ì—ë¥´íƒ€ìš´5 ì§€í•˜1ì¸µ B110í˜¸ HCH</p>
          <p class="text-red-500 font-black mt-2 text-center text-[11px]">ğŸš« è«‹å‹¿å¤–æµ ğŸš«</p>
        </div>
        <button onclick="openTrackingModal(${window.lastOrderRowIndex})" class="w-full py-3 bg-rose-500 text-white rounded-xl font-black text-sm mb-2 shadow-md mt-4">${btnText}</button>
        <p class="text-[11px] text-slate-500 text-left font-bold px-1">
          å®˜æ–¹å‡ºè²¨å¾Œï¼Œè«‹è¨˜å¾—å›å ± 12 ç¢¼è¨—é‹å–®è™Ÿã€‚
        </p>
        ${communityLink}
      `;
    } else if (currentMode === "4") {
      // æ¨¡å¼ 4ï¼šå¦‚æœæ²’è¢« window.open æ””æˆªåˆ°ï¼Œé€™è£¡è£œä¸€å€‹æŒ‰éˆ•
      body.innerHTML = '<h2 class="text-xl font-black text-slate-800 mb-2">è³£è²¨ä¾¿ä¸‹å–®</h2>' +
                      '<p class="text-sm text-slate-500 mb-6 font-bold px-4">è«‹é»æ“Šä¸‹æ–¹é€£çµå®Œæˆè³£å ´ä¸‹å–®ã€‚</p>' +
                      '<a href="' + (window.currentGroupLink || '#') + '" target="_blank" class="bg-[#f44336] text-white px-8 py-3 rounded-2xl font-black no-underline inline-block shadow-lg shadow-red-100">å‰å¾€è³£è²¨ä¾¿è³£å ´</a>' + 
                      communityLink;
    } else {
      body.innerHTML = '<h2 class="text-xl font-black text-slate-800 py-10">ç™»è¨˜æˆåŠŸï¼ğŸš€</h2>' + communityLink;
    }
    document.getElementById('bankModal').style.display = 'flex';
  }
  function openRemitFromBankModal() {
    document.getElementById('bankModal').style.display = 'none';
    if (window.lastOrderRowIndex) {
      openRemitPrompt(window.lastOrderRowIndex);
    }
  }
// è®“ä½¿ç”¨è€…å¾ã€ŒæŸ¥çœ‹è³‡è¨Šã€å½ˆçª—åˆ‡æ›åˆ°ã€Œå¡«å¯«æœ«äº”ç¢¼ã€å½ˆçª—
 function closeBankModalAndOpenRemit() {
  document.getElementById('bankModal').style.display = 'none';
  
  if (window.lastOrderRowIndex) {
    openRemitPrompt(window.lastOrderRowIndex); 
  } else {
    // å¦‚æœå…¨åŸŸè®Šæ•¸æ‰äº†ï¼Œå˜—è©¦å¾ç•«é¢çš„ Email æ¬„ä½ç¾å ´æ’ˆä¸€æ¬¡
    var email = document.getElementById('uEmail').value;
    var gid = window.currentGroupId;
    
    if(!email) {
      alert("ç„¡æ³•å–å¾—è¨‚å–®è³‡è¨Šï¼Œè«‹å¾ã€Œè¨‚å–®ç´€éŒ„ã€å›å¡«");
      return;
    }

    // ç¾å ´å»å¾Œå°æŸ¥é€™ä¸€åœ˜çš„è¡Œè™Ÿ
    google.script.run.withSuccessHandler(function(res) {
      if(res && res.rowIndex) {
        window.lastOrderRowIndex = res.rowIndex;
        openRemitPrompt(res.rowIndex);
      } else {
        alert("æ‰¾ä¸åˆ°æ‚¨çš„è¨‚å–®ç´€éŒ„ï¼Œè«‹å…ˆå®Œæˆä¸‹å–®ã€‚");
      }
    }).checkOrderAuth(gid);
  }
}
  function resetAndGoHome() {
    document.getElementById('bankModal').style.display = 'none';
    document.getElementById('calculatorView').classList.add('hidden');
    document.getElementById('homePage').classList.remove('hidden');
    document.getElementById('calcContainer').innerHTML = "";
    runningTotal = 0;
    loadGroups();
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }

  // --- æ­·å²ç´€éŒ„åŠŸèƒ½å‡ç´šå€ ---

  function showHistory() {
    // 1. å˜—è©¦å¾ç›®å‰ç•«é¢ä¸Šçš„è¼¸å…¥æ¡†æŠ“å–ï¼Œæˆ–å¾ä¹‹å‰å„²å­˜éçš„ savedInfo æŠ“å–
    var savedEmail = localStorage.getItem('comet_history_email') || savedInfo.userEmail || "";
    
    document.getElementById('historyModal').style.display = 'flex';
    
    // 2. å–å¾—æ­·å²ç´€éŒ„çš„æœå°‹æ¡†
    var searchInput = document.getElementById('historyEmailSearch');
    if (searchInput && savedEmail) {
      searchInput.value = savedEmail; // è‡ªå‹•å¡«å…¥å­˜éçš„ Email
      fetchHistory(savedEmail); // è‡ªå‹•åŸ·è¡ŒæŸ¥è©¢
    }
  }

  function queryHistoryByInput() {
  var email = document.getElementById('queryEmailInput').value.trim();
  if (!email || email.indexOf('@') === -1) {
    alert("è«‹å¡«å¯«æ­£ç¢ºçš„ Email");
    return;
  }
  
  // å­˜å…¥è¨˜æ†¶è®Šæ•¸ä¸­ï¼Œé€™æ¨£é€™ä¸€æ¬¡ç€è¦½æœŸé–“éƒ½ä¸ç”¨å†è¼¸å…¥
  savedInfo.userEmail = email;
  
  // åŸ·è¡ŒæŸ¥è©¢
  fetchHistory(email);
  
  // æŸ¥è©¢æˆåŠŸå¾Œå¯ä»¥é¸æ“‡æŠŠè¼¸å…¥æ¡†è—èµ·ä¾†
  document.getElementById('historyQueryArea').classList.add('hidden');
}

  // æ–°å¢ï¼šå¾æ˜ç´°å­—ä¸²æå–è­·ç…§å§“åçš„å·¥å…·
function extractPassportName(detailText) {
  if (!detailText) return "";
  // å‡è¨­ä½ çš„æ˜ç´°æ ¼å¼åŒ…å« "è­·ç…§å§“å: ç‹å°æ˜" æˆ– "è­·ç…§å§“åï¼šWANG XIAO MING"
  // é€™å€‹æ­£å‰‡æœƒæŠ“å–ã€Œè­·ç…§å§“åã€å¾Œé¢çš„æ–‡å­—ç›´åˆ°æ›è¡Œæˆ–çµå°¾
  var match = detailText.match(/è­·ç…§å§“å[:ï¼š]\s*([^ã€‘\n\r]+)/);
  return match ? match[1].trim() : "";
}

function fetchHistory(email) {
  google.script.run.withSuccessHandler(function(orders) {
    var historyList = document.getElementById('historyList');
    if(!orders || orders.length === 0) {
      historyList.innerHTML = "<div class='py-10 text-center text-slate-400 font-bold text-sm'>æŸ¥ç„¡è¨‚å–®ç´€éŒ„</div>";
      return;
    }

    // âœ¨ è¨˜ä½æŸ¥è©¢çš„ Email
    var info = JSON.parse(localStorage.getItem('comet_user_info') || '{}');
    info.userEmail = email;
    localStorage.setItem('comet_user_info', JSON.stringify(info));

    orders.reverse();
    var historyHtml = "";

    for (var i = 0; i < orders.length; i++) {
      var o = orders[i];
      var isVerified = (o.status === 'å·²æ ¸å°');
      var isGroupFinished = (o.groupStatus === 'åœ˜å‹™çµæŸ');
      var themeColor = getThemeColorByName(o.groupName);
      
      // æå–ä¸¦æ¸…ç†è­·ç…§å§“å
      var pName = extractPassportName(o.detail) || "";
      
      // âœ¨ é—œéµä¿®æ­£ï¼šå°‡åƒæ•¸å­—ä¸²åŒ–ï¼Œé¿å…å–®å¼•è™Ÿæˆ–æ›è¡Œææ–· HTML
      var safeMode = String(o.mode);
      var safePName = encodeURIComponent(pName);
      var safeLink = encodeURIComponent(o.link || "");
      var safeRemit = encodeURIComponent(o.remitCode || "");
      var rowIndex = o.rowIndex;

      // âœ¨ é—œéµä¿®æ­£ï¼šé‡æ–°å»ºæ§‹æŒ‰éˆ•è¡Œç‚º
      var btnAction = "";
      var btnText = "æŸ¥çœ‹è³‡è¨Š";
      var btnClass = "border-indigo-100 text-indigo-500";

      if (o.mode === "4" && o.link) {
        // æ¨¡å¼ 4 ç¶­æŒå–®ä¸€è·³è½‰æŒ‰éˆ•
        btnAction = "handleMode4(decodeURIComponent('" + safeLink + "'))";
        btnText = "æŸ¥çœ‹è³£å ´";
        btnClass = "border-rose-100 text-rose-500 bg-rose-50";
      } else {
        // ğŸš€ æ¨¡å¼ 1 & 2ï¼šæŸ¥çœ‹è³‡è¨Šæ™‚ä¹Ÿè¦é è¼‰è³‡æ–™ï¼Œç¢ºä¿ Modal è£¡é¢çš„å›å ±æŒ‰éˆ•ä¹Ÿèƒ½ä¿®æ”¹
        btnAction = "setTempRemitInfo(decodeURIComponent('" + safeRemit + "')); " + 
                    "showHistoryDetail('" + safeMode + "', decodeURIComponent('" + safePName + "'), decodeURIComponent('" + safeLink + "'), " + rowIndex + ");";
        
        // é€™è£¡ä¸éœ€è¦é¡å¤–æ”¹ btnTextï¼Œé è¨­å°±æ˜¯ã€ŒæŸ¥çœ‹è³‡è¨Šã€
      }

      var statusColors = {
        'åœ˜å‹™é€²è¡Œä¸­': 'bg-green-400 text-white', 
        'å·²æ”¶å–®': 'bg-red-400 text-white', 
        'å®˜æ–¹å‡ºè²¨ä¸­': 'bg-blue-400 text-white',
        'åˆ°é›†é‹': 'bg-purple-400 text-white', 
        'é‹å›ä¸­': 'bg-sky-400 text-white', 
        'æŠµå°å¯„å‡ºä¸­': 'bg-orange-400 text-white', 
        'åœ˜å‹™çµæŸ': 'bg-gray-400 text-white'
      };
      var groupStatusClass = statusColors[o.groupStatus] || 'bg-slate-200 text-slate-600';
      var cardStyle = isVerified ? 'filter: grayscale(0.5); opacity: 0.9; background: #f8fafc; border-color: #e2e8f0;' : 'border-color: ' + themeColor + '; background: white;';

      // å›å ±ç‹€æ…‹æ–‡å­—é¡¯ç¤º
      var remitInfoHtml = "";
      if (o.mode == "1") {
        remitInfoHtml = (o.remitCode) ? 
          '<div class="mt-2 py-1 px-3 bg-indigo-50 rounded-lg border border-indigo-100 flex items-center gap-1.5"><p class="text-[10px] font-bold text-indigo-500">å·²å¡«æœ«äº”ç¢¼ï¼š' + o.remitCode + '</p></div>' :
          (!isVerified ? '<p class="text-[10px] mt-2 font-bold text-rose-500 px-1">âš ï¸ åŒ¯æ¬¾å®Œæˆå¾Œè«‹å›å¡«æœ«äº”ç¢¼</p>' : "");
      } else if (o.mode == "2") {
        remitInfoHtml = (o.remitCode) ? 
          '<div class="mt-2 py-1 px-3 bg-rose-50 rounded-lg border border-rose-100 flex items-center gap-1.5"><p class="text-[10px] font-bold text-rose-500">å·²å¡«å–®è™Ÿï¼š' + o.remitCode + '</p></div>' :
          (!isVerified ? '<p class="text-[10px] mt-2 font-bold text-rose-500 px-1">âš ï¸ å®˜æ–¹å‡ºè²¨å¾Œè«‹å›å ±å–®è™Ÿ</p>' : "");
      }

      // âœ¨ ä¿®æ”¹æŒ‰éˆ•ç”Ÿæˆçš„ HTML
      var infoBtnHtml = isGroupFinished ? "" : 
          '<button onclick="' + btnAction + '" class="text-[10px] px-3 py-1.5 rounded-lg font-black border ' + btnClass + ' bg-white active:bg-slate-50 transition-colors">' + btnText + '</button>';
      
      // âœ¨ å…ˆç”¢å‡ºæŒ‰éˆ• HTML å­˜é€²è®Šæ•¸
      var modeActionBtnHtml = getModeActionBtn(o.mode, o.status, o.rowIndex, o.remitCode);
      // çµ„è£ HTML
      historyHtml += '<div class="p-4 rounded-2xl border-2 mb-3 text-sm shadow-sm transition-all" style="' + cardStyle + '">' +
                     '<div class="flex justify-between items-center mb-2">' +
                     '<div class="flex gap-1.5">' +
                       '<span class="text-[9px] font-black px-2 py-0.5 rounded-full ' + (isVerified ? 'bg-slate-500 text-white' : 'bg-green-100 text-green-600') + '">' + o.status + '</span>' +
                       '<span class="text-[9px] font-black px-2 py-0.5 rounded-full ' + groupStatusClass + '">' + o.groupStatus + '</span>' +
                     '</div>' +
                     '<span class="text-[10px] font-bold text-slate-400">' + (o.time || "") + '</span></div>' +
                     '<p class="font-black text-slate-800">' + o.groupName + '</p>' +
                     '<p class="text-xs text-slate-500 mt-2 whitespace-pre-line leading-relaxed">' + o.detail + '</p>' +
                     remitInfoHtml + 
                     '<div class="flex justify-between items-end mt-4 pt-3 border-t border-dashed border-slate-200">' +
                     '<div class="flex gap-2">' + 
                       infoBtnHtml + modeActionBtnHtml + 
                     '</div>' +
                     '<p class="font-black text-right ' + (isVerified ? 'text-slate-400' : '') + '" style="' + (!isVerified ? 'color:' + themeColor : '') + '">NT$ ' + (o.total || 0).toLocaleString() + '</p></div></div>';
    }
    historyList.innerHTML = historyHtml;
  }).getMyHistoryOrders(email);
}

/**
 * ğŸ’¡ æ­é…ä½¿ç”¨çš„æš«å­˜å‡½æ•¸ (è«‹æ”¾åœ¨ script æ¨™ç±¤å…§ä»»æ„è™•)
 */
function setTempRemitInfo(code) {
  window.lastRemitCode = code; // å°‡è©²ç­†è¨‚å–®å·²å¡«å¯«çš„æœ«äº”ç¢¼å­˜å…¥å…¨åŸŸè®Šæ•¸
}
  

  // æ ¹æ“šåœ˜å‹™åç¨±åˆ¤å®šæ‡‰æ´è‰²
  function getThemeColorByName(name) {
    var n = name.toUpperCase();
    if (n.includes("NCT")) return "#B0CF00";
    if (n.includes("å°‘å¥³æ™‚ä»£") || n.includes("GG") || n.includes("SNSD")) return "#FF84C3";
    if (n.includes("RIIZE") || n.includes("RZ")) return "#FF9E23";
    if (n.includes("SM")) return "#FFB3BA";
    return "#6366f1";
  }

  // æ ¹æ“šæ¨¡å¼ç”¢ç”Ÿä¸åŒçš„å‹•ä½œæŒ‰éˆ•
  function getModeActionBtn(mode, status, rowIndex, currentRemitCode) {
    if (status === 'å·²æ ¸å°') return '';
    
    var hasData = (currentRemitCode && currentRemitCode !== "");
    var setupData = "setTempRemitInfo('" + (currentRemitCode || "") + "'); ";

    if (mode == "1" || mode == 1) {
      var btnText = hasData ? "ä¿®æ”¹æœ«äº”ç¢¼" : "å¡«å¯«æœ«äº”ç¢¼";
      return '<button onclick="' + setupData + 'openRemitPrompt(' + rowIndex + ')" class="text-[10px] bg-indigo-50 text-indigo-500 px-3 py-1.5 rounded-lg font-black border border-indigo-100 active:scale-95 transition-transform">' + btnText + '</button>';
    } 
    
    // âœ¨ ä¿®æ­£é»ï¼šæ•¸å­— 2 ä¹Ÿèƒ½é€šé
    if (mode == "2" || mode == 2) {
      var btnText = hasData ? "ä¿®æ”¹å–®è™Ÿ" : "å›å ±å–®è™Ÿ";
      return '<button onclick="' + setupData + 'openTrackingModal(' + rowIndex + ')" class="text-[10px] bg-rose-50 text-rose-500 px-3 py-1.5 rounded-lg font-black border border-rose-100 active:scale-95 transition-transform">' + btnText + '</button>';
    }
    
    return '';
  }
  // æ¨¡å¼ 1 çš„å›å¡«åŠŸèƒ½
  // é–‹å•Ÿå›å ±è¦–çª—
  // æ¨¡å¼ 1ï¼šå›å ±åŒ¯æ¬¾æœ«äº”ç¢¼
 function openRemitPrompt(rowIndex) {
    if (!rowIndex) return alert("ç³»çµ±æ‰¾ä¸åˆ°è¨‚å–®ç·¨è™Ÿ");
    window.lastOrderRowIndex = rowIndex;
    
    var inputField = document.getElementById('lastFiveInput');
    
    document.getElementById('remitInputModal').style.display = 'flex';
    document.getElementById('remitModalTitle').innerText = "å¡«å¯«åŒ¯æ¬¾è³‡è¨Š";
    document.getElementById('bankSelectGroup').style.display = "block"; 
    document.getElementById('inputLabel').innerText = "å¸³æˆ¶æœ«äº”ç¢¼";
    
    inputField.value = ""; // æ¸…ç©ºä¸Šæ¬¡è¼¸å…¥
    inputField.placeholder = "è«‹è¼¸å…¥ 5 ç¢¼æ•¸å­—";
    inputField.maxLength = 5; 
    inputField.type = "tel"; // æ‰‹æ©Ÿè·³æ•¸å­—ç›¤

    // å¦‚æœæ­·å²ç´€éŒ„æœ‰èˆŠè³‡æ–™ï¼Œè‡ªå‹•å¡«å…¥
    if (window.lastRemitCode && !window.lastRemitCode.includes("å–®è™Ÿ")) {
        // å‡è¨­æ ¼å¼æ˜¯ "éŠ€è¡Œ - 12345"ï¼Œåˆ‡å‡ºå¾Œé¢ 5 ç¢¼
        var parts = window.lastRemitCode.split(" - ");
        inputField.value = parts.length > 1 ? parts[1] : "";
    }
    
    var submitBtn = document.getElementById('submitRemitBtn');
    submitBtn.onclick = function() {
      var bank = document.getElementById('bankSelect').value;
      var code = inputField.value.trim();
      if (code.length !== 5) return alert("âŒ è«‹è¼¸å…¥æ­£ç¢ºçš„ 5 ç¢¼æ•¸å­—ï¼");
      sendUpdate(rowIndex, bank + " - " + code);
    };
  }

  // æ¨¡å¼ 2ï¼šå›å ±éŸ“åœ‹è¨—é‹å–®è™Ÿ
  function openTrackingModal(rowIndex) {
    if (!rowIndex) return alert("ç³»çµ±æ‰¾ä¸åˆ°è¨‚å–®ç·¨è™Ÿï¼Œè«‹é‡æ–°æ•´ç†é é¢ã€‚");
    window.lastOrderRowIndex = rowIndex; 
    
    var inputField = document.getElementById('lastFiveInput');
    document.getElementById('remitInputModal').style.display = 'flex';
    
    var hasData = (window.lastRemitCode && window.lastRemitCode !== "");
    document.getElementById('remitModalTitle').innerText = hasData ? "ä¿®æ”¹è¨—é‹å–®è™Ÿ" : "å›å ±è¨—é‹å–®è™Ÿ";
    
    document.getElementById('bankSelectGroup').style.display = "none"; 
    document.getElementById('inputLabel').innerText = "éŸ“åœ‹å¿«éå–®è™Ÿ (12ç¢¼)";
    
    inputField.value = ""; // æ¸…ç©º
    inputField.placeholder = "è«‹è¼¸å…¥ 12 ç¢¼æ•¸å­—";
    inputField.maxLength = 12; 
    inputField.type = "tel"; 

    if(hasData) {
      inputField.value = window.lastRemitCode;
    }

    document.getElementById('submitRemitBtn').onclick = function() {
      var code = inputField.value.trim();
      var cleanCode = code.replace(/\D/g, ''); // åªä¿ç•™æ•¸å­—
      
      if (cleanCode.length !== 12) {
        alert("âŒ æ ¼å¼éŒ¯èª¤ï¼å–®è™Ÿæ‡‰ç‚ºã€Œ12 ç¢¼ç´”æ•¸å­—ã€ã€‚\nç›®å‰é•·åº¦ï¼š" + cleanCode.length + " ç¢¼");
        return;
      }
      // ğŸ’¡ é€™è£¡ç›´æ¥å‚³é€ cleanCodeï¼Œä¸åŠ ã€Œå–®è™Ÿï¼šã€å­—æ¨£
      sendUpdate(rowIndex, cleanCode);
    };
  }

  // çµ±ä¸€çš„å‚³é€å‡½æ•¸
  function sendUpdate(rowIndex, finalData) {
    var btn = document.getElementById('submitRemitBtn');
    btn.disabled = true;
    btn.innerText = "å‚³é€ä¸­...";
    
    google.script.run.withSuccessHandler(function(res) {
      if(res) {
        alert("âœ… è³‡è¨Šå·²æ›´æ–°ï¼");
        closeRemitModal();
        if (savedInfo.userEmail) fetchHistory(savedInfo.userEmail);
      }
      btn.disabled = false;
      btn.innerText = "ç¢ºèªæäº¤";
    }).updateOrderRemitCode(rowIndex, finalData);
  }

  // é—œé–‰å›å ±è¦–çª—
  function closeRemitModal() {
    const modal = document.getElementById('remitInputModal');
    const input = document.getElementById('lastFiveInput');
    const btn = document.getElementById('submitRemitBtn');

    // 1. éš±è—è¦–çª—
    modal.style.display = 'none';
    
    // 2. æ¸…ç©ºè¼¸å…¥å…§å®¹
    input.value = "";
    
    // 3. æ¢å¾©æŒ‰éˆ•ç‹€æ…‹ (é¿å…ä½¿ç”¨è€…åœ¨å‚³é€ä¸­å¼·è¡Œé—œé–‰å¾Œï¼ŒæŒ‰éˆ•ä¸€ç›´å¡åœ¨ã€Œå‚³é€ä¸­ã€)
    btn.disabled = false;
    btn.innerText = "ç¢ºèªæäº¤";
    
    // 4. (é¸å¡«) æ¢å¾©é è¨­ UIï¼Œé¿å…ä¸‹æ¬¡æ‰“é–‹æ¨¡å¼ 1 æ™‚çœ‹åˆ°æ¨¡å¼ 2 çš„æ¨™é¡Œ
    document.getElementById('bankSelectGroup').style.display = "block";
    document.getElementById('remitModalTitle').innerText = "å¡«å¯«è³‡è¨Š";
  }
  
  function goBackToList() { resetAndGoHome(); }
</script>
</body>
</html>